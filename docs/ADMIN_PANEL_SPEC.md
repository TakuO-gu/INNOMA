# 管理画面 設計書

**作成日**: 2026-01-20
**最終更新**: 2026-01-27

---

## 1. 概要

INNOMAの運用を行うための管理画面。
シンプルなテーブル形式のUIで、自治体の管理・下書き承認・手動編集を行う。

---

## 2. 認証

### 2.1 開発フェーズ
- **認証なし**（開発中のため）
- `/admin` に直接アクセス可能

### 2.2 将来の認証方式（検討）
- Vercel Password Protection（デプロイ時）
- または NextAuth.js + Google OAuth

---

## 3. 画面構成

```
/admin
├── /                              # ダッシュボード
├── /municipalities                # 自治体一覧
├── /municipalities/new            # 新規自治体追加
├── /municipalities/[id]           # 自治体詳細
├── /drafts                        # 下書き一覧
├── /drafts/[municipalityId]/[service]  # 下書き詳細・承認（3分割ビュー）
├── /notifications                 # 通知一覧
└── /settings                      # 設定（将来）
```

---

## 4. 画面詳細

### 4.1 ダッシュボード（/admin）

自治体一覧と主要なアクションへのクイックアクセス。

```
┌─────────────────────────────────────────────────────────────┐
│ INNOMA 管理画面                                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [+ 新規自治体追加]                                          │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 自治体一覧                                           │   │
│  ├──────────┬────────────┬────────────┬───────────────┤   │
│  │ 自治体名  │ ステータス  │ 最終更新   │ アクション     │   │
│  ├──────────┼────────────┼────────────┼───────────────┤   │
│  │ 青ヶ島村  │ ✅ 公開中   │ 2026-01-20 │ [詳細] [更新]  │   │
│  │ 三笠市    │ 📝 下書き有 │ 2026-01-19 │ [詳細] [承認]  │   │
│  │ 高岡市    │ ⏳ 処理中   │ 2026-01-18 │ [詳細]         │   │
│  └──────────┴────────────┴────────────┴───────────────┘   │
│                                                              │
│  未承認の下書き: 3件  [すべて表示 →]                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**ステータス**:
- ✅ 公開中: 全変数が埋まり公開されている
- 📝 下書き有: LLMが取得した下書きが承認待ち
- ⏳ 処理中: LLM情報取得中
- ⚠️ エラー: 取得失敗した変数あり

---

### 4.2 新規自治体追加（/admin/municipalities/new）

```
┌─────────────────────────────────────────────────────────────┐
│ 新規自治体追加                                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  自治体ID *                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ aogashima                                            │   │
│  └─────────────────────────────────────────────────────┘   │
│  ※ URLパスに使用（英数字、ハイフンのみ）                     │
│                                                              │
│  自治体名 *                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 青ヶ島村                                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  都道府県 *                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 東京都                                        ▼     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  公式サイトURL                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ https://www.vill.aogashima.tokyo.jp/                │   │
│  └─────────────────────────────────────────────────────┘   │
│  ※ LLMが情報を取得する際に参照                              │
│                                                              │
│  ☑ 追加後すぐにLLM情報取得を開始                            │
│                                                              │
│  [キャンセル]                              [追加]            │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**処理フロー**:
1. フォーム送信
2. テンプレート（sample/）を複製
3. 基本変数（municipality_name等）を置換
4. チェックがあればLLM情報取得をキュー登録
5. 自治体詳細ページにリダイレクト

---

### 4.3 自治体詳細（/admin/municipalities/[id]）

3カラムレイアウトで、基本情報・変数一覧・サービス別進捗を表示。

```
┌─────────────────────────────────────────────────────────────┐
│ ← 戻る    青ヶ島村            [公開する] / [非公開にする]    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌───────────────┐  ┌────────────────────────────────────┐ │
│  │ 基本情報       │  │ サービス別変数設定状況               │ │
│  │ ID: aogashima │  │ ┌────────────────────┬─────────┐   │ │
│  │ 都道府県: 東京│  │ │ 届出・申請・証明書  │ ████░ 80%│   │ │
│  │ 公式サイト:   │  │ │ 税金              │ ███░░ 60%│   │ │
│  │ ...           │  │ │ 健康・医療        │ █████ 100%│   │ │
│  │               │  │ │ 子育て・保育      │ ██░░░ 40%│   │ │
│  │ [情報を取得]  │  │ │ ...              │          │   │ │
│  │ [削除]        │  │ └────────────────────┴─────────┘   │ │
│  └───────────────┘  └────────────────────────────────────┘ │
│                                                              │
│  変数一覧（インライン編集可能）                              │
│  ┌──────────────────┬─────────────────┬────────┬────────┐ │
│  │ 変数名            │ 値              │ ソース │ 操作   │ │
│  ├──────────────────┼─────────────────┼────────┼────────┤ │
│  │ city_hall_phone   │ 04996-9-0111   │ LLM    │ [編集] │ │
│  │ kokuho_phone      │ （未設定）      │ -      │ [編集] │ │
│  └──────────────────┴─────────────────┴────────┴────────┘ │
│                                                              │
│  編集履歴                                                    │
│  ┌──────────┬────────┬────────────┬──────────────────────┐ │
│  │ 日時      │ 種類   │ 変更数     │ ソース               │ │
│  ├──────────┼────────┼────────────┼──────────────────────┤ │
│  │ 01/20    │ 手動   │ 3件        │ admin               │ │
│  │ 01/19    │ 承認   │ 15件       │ 下書き(kokuho)       │ │
│  └──────────┴────────┴────────────┴──────────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**コンポーネント**:
- `FetchButton`: 情報取得（サービス選択UI付き）
- `PublishButton`: 公開/非公開切替
- `VariableTable`: 変数一覧（インライン編集）
- `ServiceVariableStats`: サービス別進捗
- `HistoryTable`: 編集履歴

**アクション**:
- 🔄 情報を取得: サービスを選択してLLM取得
  - 未取得のみ / 全て再取得 / サービス選択
  - 中断・再開対応
- 📝 インライン編集: 変数を直接編集
- 📤 公開/非公開: ステータス切替
- 🗑️ 削除: 自治体を削除

---

### 4.4 下書き一覧（/admin/drafts）

```
┌─────────────────────────────────────────────────────────────┐
│ 下書き一覧                                                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [すべて選択]  [選択した下書きを一括承認]                    │
│                                                              │
│  ┌────┬──────────┬────────────┬────────────┬───────────┐   │
│  │ ☐  │ 自治体    │ サービス    │ 更新日時    │ 変更数    │   │
│  ├────┼──────────┼────────────┼────────────┼───────────┤   │
│  │ ☐  │ 青ヶ島村  │ 国民健康保険│ 2026-01-20 │ 5件       │   │
│  │ ☐  │ 青ヶ島村  │ 住民票     │ 2026-01-20 │ 3件       │   │
│  │ ☐  │ 三笠市    │ 戸籍       │ 2026-01-19 │ 8件       │   │
│  └────┴──────────┴────────────┴────────────┴───────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 4.5 下書き詳細・承認（/admin/drafts/[municipalityId]/[service]）

3分割ビューで、変数リスト・サンプルページ・ソースコンテンツを同時に確認。

```
┌─────────────────────────────────────────────────────────────┐
│ ← 戻る    青ヶ島村 / 国民健康保険                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [承認して反映]  [却下]  [削除]                              │
│                                                              │
│  ┌──────────┐  ┌───────────────────┐  ┌──────────────────┐ │
│  │変数リスト  │  │サンプルページ      │  │ソースコンテンツ   │ │
│  │(25%)      │  │(37.5%)            │  │(37.5%)           │ │
│  ├──────────┤  ├───────────────────┤  ├──────────────────┤ │
│  │[取得済み] │  │                   │  │                  │ │
│  │[未取得]   │  │  サンプル市の      │  │ 取得元URLの      │ │
│  │          │  │  ページを表示      │  │ コンテンツを表示  │ │
│  │○ phone   │  │                   │  │                  │ │
│  │  95%     │  │  選択した変数の    │  │ 取得した値が     │ │
│  │  新規    │  │  使用箇所を       │  │ ハイライト表示   │ │
│  │          │  │  黄色ハイライト    │  │                  │ │
│  │○ hours   │  │                   │  │                  │ │
│  │  90%     │  │                   │  │                  │ │
│  │  変更    │  │                   │  │                  │ │
│  └──────────┘  └───────────────────┘  └──────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**コンポーネント**:
- `VariableContextViewer`: 3分割ビューのメインコンポーネント
- `SourceViewer`: ソースコンテンツ表示
- `TemplatePreview`: サンプルページプレビュー
- `DraftActions`: アクションボタン

**変数リスト機能**:
- タブ切替: 取得済み / 未取得
- 信頼度カラーコード: 緑(≥80%) / 黄(≥50%) / 赤(<50%)
- 変更タイプ表示: 新規 / 変更
- クリックで詳細表示

**アクション**:
- 承認して反映: 下書きをvariables.jsonに反映 + ISR再検証
- 却下: 下書きを却下（理由を記録）
- 削除: 下書きを完全削除

---

## 5. API設計

### 5.1 エンドポイント

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/admin/municipalities` | 自治体一覧 |
| POST | `/api/admin/municipalities` | 自治体追加 |
| GET | `/api/admin/municipalities/[id]` | 自治体詳細 |
| PUT | `/api/admin/municipalities/[id]` | 自治体更新（ステータス変更含む） |
| DELETE | `/api/admin/municipalities/[id]` | 自治体削除 |
| POST | `/api/admin/municipalities/[id]/fetch` | 情報取得（SSE） |
| GET | `/api/admin/municipalities/[id]/fetch/status` | 取得状況確認 |
| PUT | `/api/admin/municipalities/[id]/variables` | 変数更新 |
| GET | `/api/admin/municipalities/[id]/history` | 編集履歴 |
| GET | `/api/admin/drafts` | 下書き一覧 |
| GET | `/api/admin/drafts/[municipalityId]/[service]` | 下書き詳細 |
| PUT | `/api/admin/drafts/[municipalityId]/[service]` | 承認/却下 |
| DELETE | `/api/admin/drafts/[municipalityId]/[service]` | 下書き削除 |
| GET | `/api/admin/drafts/[municipalityId]/[service]/source` | ソースコンテンツ |
| GET | `/api/admin/drafts/[municipalityId]/[service]/template` | サンプルページ |
| GET | `/api/admin/notifications` | 通知一覧 |
| PUT | `/api/admin/notifications` | 既読にする |
| DELETE | `/api/admin/notifications` | 通知削除 |
| POST | `/api/admin/pdf/ocr` | PDF OCR実行 |
| GET | `/api/admin/pdf/ocr` | OCRキャッシュ確認 |

### 5.2 レスポンス例

**GET /api/admin/municipalities**
```json
{
  "municipalities": [
    {
      "id": "aogashima",
      "name": "青ヶ島村",
      "prefecture": "東京都",
      "status": "published",
      "updatedAt": "2026-01-20T10:30:00Z",
      "variableStats": {
        "total": 353,
        "filled": 280,
        "missing": 73
      },
      "pendingDrafts": 2
    }
  ]
}
```

**GET /api/admin/drafts/[id]**
```json
{
  "id": "draft-123",
  "municipalityId": "aogashima",
  "service": "kokuho",
  "createdAt": "2026-01-20T10:00:00Z",
  "changes": [
    {
      "variable": "kokuho_phone",
      "currentValue": null,
      "newValue": "04996-9-0111",
      "sourceUrl": "https://...",
      "confidence": 0.95
    }
  ],
  "missingVariables": ["kokuho_premium_rate"]
}
```

---

## 6. データ構造

### 6.1 自治体メタデータ

`/data/artifacts/{municipality}/meta.json`

```json
{
  "id": "aogashima",
  "name": "青ヶ島村",
  "prefecture": "東京都",
  "officialUrl": "https://www.vill.aogashima.tokyo.jp/",
  "createdAt": "2026-01-15T00:00:00Z",
  "updatedAt": "2026-01-20T10:30:00Z",
  "lastFetchAt": "2026-01-20T10:00:00Z",
  "status": "published",
  "settings": {
    "autoPublish": false,
    "fetchInterval": "weekly"
  }
}
```

### 6.2 変数値ストア

`/data/artifacts/{municipality}/variables.json`

```json
{
  "city_hall_phone": {
    "value": "04996-9-0111",
    "source": "llm",
    "sourceUrl": "https://...",
    "confidence": 0.98,
    "updatedAt": "2026-01-20T10:00:00Z"
  },
  "juminhyo_fee": {
    "value": "300円",
    "source": "manual",
    "updatedAt": "2026-01-18T15:00:00Z"
  }
}
```

### 6.3 下書き

`/data/artifacts/_drafts/{municipality}/{service}.json`

```json
{
  "id": "draft-123",
  "municipalityId": "aogashima",
  "service": "kokuho",
  "status": "pending",
  "createdAt": "2026-01-20T10:00:00Z",
  "changes": { ... },
  "missingVariables": [ ... ]
}
```

---

## 7. 実装状況

### Phase 1（MVP）✅
1. ダッシュボード（自治体一覧）
2. 新規自治体追加
3. 自治体詳細（変数一覧）

### Phase 2 ✅
4. 下書き一覧・承認
5. 手動編集機能（インライン編集）
6. 情報取得トリガー（サービス選択UI）

### Phase 3 ✅
7. 通知システム（ベル + 一覧ページ）
8. 編集履歴表示
9. 3分割ビュー（下書き詳細）

### Phase 4（今後）
10. 一括操作
11. 検索・フィルタ
12. 認証追加

---

## 8. 技術実装

- **フレームワーク**: Next.js App Router
- **スタイリング**: Tailwind CSS
- **状態管理**: React Server Components + Server Actions
- **バリデーション**: Zod
- **API**: Route Handlers

**ディレクトリ構造**:
```
apps/web/
├── app/
│   └── admin/
│       ├── page.tsx                    # ダッシュボード
│       ├── layout.tsx                  # 管理画面レイアウト
│       ├── municipalities/
│       │   ├── page.tsx                # 一覧
│       │   ├── new/page.tsx            # 新規追加
│       │   └── [id]/
│       │       ├── page.tsx            # 詳細
│       │       ├── FetchButton.tsx     # 情報取得（サービス選択）
│       │       ├── PublishButton.tsx   # 公開/非公開
│       │       ├── VariableTable.tsx   # 変数一覧（インライン編集）
│       │       ├── ServiceVariableStats.tsx  # サービス別進捗
│       │       └── HistoryTable.tsx    # 編集履歴
│       ├── drafts/
│       │   ├── page.tsx                # 一覧
│       │   └── [municipalityId]/
│       │       └── [service]/
│       │           ├── page.tsx        # 詳細
│       │           ├── DraftActions.tsx
│       │           ├── VariableContextViewer.tsx  # 3分割ビュー
│       │           ├── SourceViewer.tsx
│       │           └── TemplatePreview.tsx
│       ├── notifications/
│       │   └── page.tsx                # 通知一覧
│       └── components/
│           └── NotificationBell.tsx    # 通知ベル
├── lib/
│   ├── drafts/                         # 下書き管理
│   ├── jobs/                           # ジョブ状態
│   ├── history/                        # 編集履歴
│   └── notification/                   # 通知
└── app/api/admin/
    ├── municipalities/
    │   ├── route.ts
    │   └── [id]/
    │       ├── route.ts
    │       ├── fetch/route.ts          # SSE
    │       ├── fetch/status/route.ts
    │       ├── variables/route.ts
    │       └── history/route.ts
    ├── drafts/
    │   ├── route.ts
    │   └── [municipalityId]/
    │       └── [service]/
    │           ├── route.ts
    │           ├── source/route.ts
    │           └── template/route.ts
    ├── notifications/route.ts
    └── pdf/ocr/route.ts
```
