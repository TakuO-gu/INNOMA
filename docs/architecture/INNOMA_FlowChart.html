<!DOCTYPE html><html><head>
      <title>INNOMA_FlowChart</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/ogtk/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.20/crossnote/dependencies/katex/katex.min.css">
      
      
      <script type="text/javascript" src="file:////Users/ogtk/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.20/crossnote/dependencies/mermaid/mermaid.min.js" charset="UTF-8"></script>
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="innoma-実装フローチャート">INNOMA 実装フローチャート </h1>
<h2 id="目次">目次 </h2>
<ol>
<li><a href="#1-%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AD%E3%83%BC%E6%A6%82%E8%A6%81">メインデータフロー概要</a></li>
<li><a href="#2-%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E3%83%95%E3%83%AD%E3%83%BC">ページレンダリングフロー</a></li>
<li><a href="#3-llm%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97%E3%83%95%E3%83%AD%E3%83%BC">LLM情報取得フロー</a></li>
<li><a href="#4-%E3%83%89%E3%83%A9%E3%83%95%E3%83%88%E7%AE%A1%E7%90%86%E3%83%95%E3%83%AD%E3%83%BC">ドラフト管理フロー</a></li>
<li><a href="#5-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E5%A4%89%E6%95%B0%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0">テンプレート・変数システム</a></li>
<li><a href="#6-%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E3%83%95%E3%83%AD%E3%83%BC">管理画面フロー</a></li>
<li><a href="#7-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E6%8A%BD%E8%B1%A1%E5%8C%96%E5%B1%A4">ストレージ抽象化層</a></li>
<li><a href="#8-%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88%E9%9A%8E%E5%B1%A4">コンポーネント階層</a></li>
<li><a href="#9-%E8%AA%8D%E8%A8%BC%E3%83%9F%E3%83%89%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2">認証・ミドルウェア</a></li>
<li><a href="#10-%E6%9C%AA%E4%BD%BF%E7%94%A8%E5%8F%82%E7%85%A7%E7%94%A8%E3%82%B3%E3%83%BC%E3%83%89">未使用・参照用コード</a></li>
</ol>
<hr>
<h2 id="1-メインデータフロー概要">1. メインデータフロー概要 </h2>
<div class="mermaid">flowchart TB
    subgraph User["ユーザーフロー"]
        U1[ユーザーアクセス]
        U2[ページ閲覧]
        U3[検索]
    end

    subgraph Admin["管理者フロー"]
        A1[管理画面ログイン]
        A2[自治体作成]
        A3[情報取得開始]
        A4[ドラフトレビュー]
        A5[承認・公開]
    end

    subgraph Core["コアシステム"]
        C1[(テンプレート)]
        C2[(変数ストア)]
        C3[(アーティファクト)]
        C4[LLM Fetcher]
        C5[ドラフト管理]
    end

    subgraph External["外部サービス"]
        E1[Google Gemini]
        E2[Google Custom Search]
        E3[Google Vision OCR]
        E4[自治体Webサイト]
    end

    U1 --&gt; C3
    C3 --&gt; U2

    A1 --&gt; A2
    A2 --&gt; C1
    C1 --&gt; C2
    A3 --&gt; C4
    C4 --&gt; E1
    C4 --&gt; E2
    C4 --&gt; E4
    E4 --&gt; E3
    C4 --&gt; C5
    C5 --&gt; A4
    A4 --&gt; A5
    A5 --&gt; C2
    C2 --&gt; C3
</div><hr>
<h2 id="2-ページレンダリングフロー">2. ページレンダリングフロー </h2>
<h3 id="21-メインレンダリングパイプライン">2.1 メインレンダリングパイプライン </h3>
<div class="mermaid">flowchart TD
    subgraph Entry["エントリーポイント"]
        P1["app/[municipality]/[[...path]]/page.tsx&lt;br/&gt;ArtifactPage()"]
    end

    subgraph ArtifactLoading["アーティファクト読込"]
        AL1["buildArtifactKey()&lt;br/&gt;URLからキー生成"]
        AL2["loadArtifact()&lt;br/&gt;lib/artifact/index.ts"]
        AL3["loadArtifactInternal()&lt;br/&gt;lib/artifact/loader.ts"]
        AL4["getFromCache()&lt;br/&gt;lib/artifact/cache.ts"]
        AL5["getDefaultStorageAdapter().get()&lt;br/&gt;lib/storage/index.ts"]
        AL6["getVariableStore()&lt;br/&gt;lib/template/storage.ts"]
        AL7["replaceVariablesWithSources()&lt;br/&gt;lib/template/replace.ts"]
        AL8["safeValidateArtifact()&lt;br/&gt;lib/artifact/schema.ts"]
        AL9["setInCache()&lt;br/&gt;lib/artifact/cache.ts"]
    end

    subgraph Rendering["レンダリング"]
        R1["getCompletedPages()&lt;br/&gt;lib/artifact/index.ts"]
        R2["BlockRenderer&lt;br/&gt;components/blocks/BlockRenderer.tsx"]
        R3["MunicipalityProvider&lt;br/&gt;components/blocks/MunicipalityContext.tsx"]
        R4["各Blockコンポーネント&lt;br/&gt;components/blocks/components/"]
    end

    P1 --&gt; AL1
    AL1 --&gt; AL2
    AL2 --&gt; AL3
    AL3 --&gt; AL4
    AL4 --&gt;|キャッシュヒット| AL9
    AL4 --&gt;|キャッシュミス| AL5
    AL5 --&gt; AL6
    AL6 --&gt; AL7
    AL7 --&gt; AL8
    AL8 --&gt; AL9
    AL9 --&gt; R1
    R1 --&gt; R2
    R2 --&gt; R3
    R3 --&gt; R4
</div><h3 id="22-変数置換処理">2.2 変数置換処理 </h3>
<div class="mermaid">flowchart LR
    subgraph Input["入力"]
        I1["アーティファクトJSON&lt;br/&gt;{{variable_name}}を含む"]
        I2["変数ストア&lt;br/&gt;variables.json"]
    end

    subgraph Replace["置換処理 - lib/template/replace.ts"]
        RP1["replaceVariables()"]
        RP2["replaceVariablesWithSources()"]
        RP3["extractVariables()&lt;br/&gt;正規表現マッチ"]
        RP4["hasUnreplacedVariables()&lt;br/&gt;未置換チェック"]
    end

    subgraph Output["出力"]
        O1["置換済みアーティファクト"]
        O2["ソース情報&lt;br/&gt;sources配列"]
        O3["未置換変数リスト"]
    end

    I1 --&gt; RP1
    I2 --&gt; RP1
    RP1 --&gt; RP2
    RP2 --&gt; RP3
    RP3 --&gt; RP4
    RP4 --&gt; O1
    RP4 --&gt; O2
    RP4 --&gt; O3
</div><h3 id="23-キャッシュ管理">2.3 キャッシュ管理 </h3>
<div class="mermaid">flowchart TD
    subgraph CacheLayer["キャッシュ層 - lib/artifact/cache.ts"]
        C1["getFromCache(key)"]
        C2["setInCache(key, value, ttl)"]
        C3["invalidateCache(key)"]
        C4["invalidateCacheByPrefix(prefix)"]
    end

    subgraph TTL["TTL計算"]
        T1["通常コンテンツ: 300秒"]
        T2["緊急コンテンツ: 60秒"]
    end

    subgraph ReactCache["React Server Cache"]
        RC1["React.cache()&lt;br/&gt;リクエスト単位キャッシュ"]
    end

    C1 --&gt; T1
    C1 --&gt; T2
    C2 --&gt; T1
    C2 --&gt; T2
    RC1 --&gt; C1
</div><hr>
<h2 id="3-llm情報取得フロー">3. LLM情報取得フロー </h2>
<h3 id="31-メイン取得オーケストレーション">3.1 メイン取得オーケストレーション </h3>
<div class="mermaid">flowchart TD
    subgraph API["API - app/api/admin/municipalities/[id]/fetch/route.ts"]
        A1["POST /fetch&lt;br/&gt;SSEストリーミング"]
        A2["getLatestJob()&lt;br/&gt;ジョブ状態確認"]
        A3["createFetchJob()&lt;br/&gt;ジョブ作成"]
    end

    subgraph Fetcher["取得処理 - lib/llm/fetcher.ts"]
        F1["fetchServiceVariables()"]
        F2["getServiceDefinition()&lt;br/&gt;lib/llm/variable-priority.ts"]
        F3["generateSearchQuery()&lt;br/&gt;lib/llm/prompts/query-generator.ts"]
        F4["searchMunicipalitySite()&lt;br/&gt;lib/llm/google-search.ts"]
        F5["extractFromSnippets()&lt;br/&gt;lib/llm/prompts/extractor.ts"]
        F6["fetchPageWithPdfs()&lt;br/&gt;lib/llm/page-fetcher.ts"]
        F7["extractVariables()&lt;br/&gt;lib/llm/prompts/extractor.ts"]
        F8["validateVariable()&lt;br/&gt;lib/llm/validators.ts"]
    end

    subgraph DeepSearch["ディープサーチ - lib/llm/deep-search.ts"]
        D1["isConcreteValue()&lt;br/&gt;値の妥当性チェック"]
        D2["深掘り検索ロジック"]
    end

    subgraph Crawler["Playwrightクローラー - lib/llm/playwright-crawler.ts"]
        CR1["crawlForVariables()&lt;br/&gt;JS重いサイト対応"]
    end

    subgraph Draft["ドラフト保存 - lib/drafts/storage.ts"]
        DR1["saveDraft()"]
    end

    A1 --&gt; A2
    A2 --&gt; A3
    A3 --&gt; F1
    F1 --&gt; F2
    F2 --&gt; F3
    F3 --&gt; F4
    F4 --&gt; F5
    F5 --&gt;|不十分| F6
    F5 --&gt;|十分| F8
    F6 --&gt; F7
    F7 --&gt; F8
    F8 --&gt;|失敗| D1
    D1 --&gt; D2
    D2 --&gt;|JSサイト| CR1
    F8 --&gt;|成功| DR1
    CR1 --&gt; DR1
</div><h3 id="32-検索処理">3.2 検索処理 </h3>
<div class="mermaid">flowchart LR
    subgraph Query["クエリ生成 - lib/llm/prompts/query-generator.ts"]
        Q1["generateSearchQuery()"]
        Q2["generateServiceSearchQueries()"]
    end

    subgraph Gemini["Gemini API - lib/llm/gemini.ts"]
        G1["generateContent()"]
        G2["generateJSON()"]
    end

    subgraph Search["検索 - lib/llm/google-search.ts"]
        S1["googleSearch()&lt;br/&gt;Raw API呼出"]
        S2["searchMunicipalitySite()&lt;br/&gt;サイト限定検索"]
        S3["searchServiceInfo()&lt;br/&gt;サービス検索"]
        S4["isOfficialDomain()&lt;br/&gt;公式ドメイン判定"]
        S5["calculateUrlCredibility()&lt;br/&gt;信頼度スコア計算"]
    end

    subgraph BraveSearch["Brave Search - lib/llm/brave-search.ts"]
        B1["braveSearch()&lt;br/&gt;フォールバック"]
    end

    Q1 --&gt; G1
    Q2 --&gt; G1
    G1 --&gt; S1
    S1 --&gt; S2
    S2 --&gt; S3
    S3 --&gt; S4
    S4 --&gt; S5
    S1 --&gt;|失敗時| B1
</div><h3 id="33-コンテンツ取得抽出">3.3 コンテンツ取得・抽出 </h3>
<div class="mermaid">flowchart TD
    subgraph PageFetch["ページ取得 - lib/llm/page-fetcher.ts"]
        PF1["fetchPage(url)"]
        PF2["fetchPages(urls)&lt;br/&gt;並列取得"]
        PF3["fetchPageWithPdfs(url)"]
        PF4["isUsefulUrl(url)&lt;br/&gt;有用性判定"]
    end

    subgraph PDF["PDF処理 - lib/pdf/"]
        PDF1["extractTextFromPdf()&lt;br/&gt;pdf-to-images.ts"]
        PDF2["convertPdfToImages()&lt;br/&gt;pdf-to-images.ts"]
        PDF3["performVisionOcr()&lt;br/&gt;vision-ocr.ts"]
        PDF4["extractTextFromBase64Image()&lt;br/&gt;vision-ocr.ts"]
        PDF5["getCachedOcr() / setCachedOcr()&lt;br/&gt;cache.ts"]
    end

    subgraph Extract["抽出 - lib/llm/prompts/extractor.ts"]
        E1["extractVariables()"]
        E2["extractFromSnippets()"]
        E3["extractContactInfo()"]
        E4["extractFeeInfo()"]
    end

    subgraph Validate["検証 - lib/llm/validators.ts"]
        V1["validateVariable()&lt;br/&gt;自動判別"]
        V2["getValidator()&lt;br/&gt;バリデータ取得"]
        V3["calculateValidationConfidence()"]
        V4["個別バリデータ&lt;br/&gt;Phone/Email/Url/Fee&lt;br/&gt;Date/Time/PostalCode/Percent"]
    end

    PF1 --&gt; PF4
    PF2 --&gt; PF4
    PF3 --&gt; PDF1
    PDF1 --&gt;|画像ベースPDF| PDF2
    PDF2 --&gt; PDF3
    PDF3 --&gt; PDF4
    PDF4 --&gt; PDF5
    PF4 --&gt; E1
    PDF5 --&gt; E1
    E1 --&gt; E3
    E1 --&gt; E4
    E2 --&gt; V1
    E1 --&gt; V1
    V1 --&gt; V4
    V2 --&gt; V3
</div><h3 id="34-変数定義優先度">3.4 変数定義・優先度 </h3>
<div class="mermaid">flowchart LR
    subgraph Priority["変数優先度 - lib/llm/variable-priority.ts"]
        P1["highPriorityVariables[]"]
        P2["serviceDefinitions[]"]
        P3["getServiceDefinition()"]
        P4["getVariableDefinition()"]
        P5["districtDependentVariables[]"]
        P6["isDistrictDependentVariable()"]
    end

    subgraph Services["15サービスカテゴリ"]
        S["registration / tax / health&lt;br/&gt;childcare / welfare / disaster&lt;br/&gt;housing / employment / driving&lt;br/&gt;business / land / nationality&lt;br/&gt;civic / benefits / environment"]
    end

    P1 --&gt; P3
    P2 --&gt; P3
    P3 --&gt; S
    P5 --&gt; P6
</div><hr>
<h2 id="4-ドラフト管理フロー">4. ドラフト管理フロー </h2>
<h3 id="41-ドラフトライフサイクル">4.1 ドラフトライフサイクル </h3>
<div class="mermaid">flowchart TD
    subgraph Create["ドラフト作成"]
        C1["LLM Fetcher完了"]
        C2["saveDraft()&lt;br/&gt;lib/drafts/storage.ts"]
        C3["createDraft()&lt;br/&gt;lib/drafts/storage.ts"]
    end

    subgraph Storage["ストレージ - lib/drafts/storage.ts"]
        S1["getAllDrafts()"]
        S2["getMunicipalityDrafts()"]
        S3["getDraft()"]
        S4["updateDraftStatus()"]
        S5["updateDraftVariables()"]
        S6["deleteDraft()"]
        S7["getDraftsByStatus()"]
        S8["getDraftStatistics()"]
    end

    subgraph Review["レビュー"]
        R1["管理画面: ドラフト詳細"]
        R2["3分割ビュー表示"]
    end

    subgraph Diff["差分比較 - lib/drafts/diff.ts"]
        D1["compareDraftWithStore()"]
        D2["getDraftComparison()"]
        D3["getChangedVariables()"]
        D4["generateDiffSummary()"]
        D5["hasSignificantChanges()"]
    end

    subgraph Apply["適用"]
        A1["applyDraftToStore()&lt;br/&gt;lib/drafts/diff.ts"]
        A2["updateVariableStore()&lt;br/&gt;lib/template/storage.ts"]
        A3["recordVariableUpdate()&lt;br/&gt;lib/history/storage.ts"]
    end

    subgraph Status["ステータス"]
        ST1["pending_review&lt;br/&gt;レビュー待ち"]
        ST2["approved&lt;br/&gt;承認済み"]
        ST3["rejected&lt;br/&gt;却下"]
    end

    C1 --&gt; C2
    C2 --&gt; C3
    C3 --&gt; ST1
    ST1 --&gt; R1
    R1 --&gt; R2
    R2 --&gt; D1
    D1 --&gt; D2
    D2 --&gt; D3
    D3 --&gt; D4
    D4 --&gt; D5
    D5 --&gt;|承認| A1
    D5 --&gt;|却下| ST3
    A1 --&gt; A2
    A2 --&gt; A3
    A3 --&gt; ST2
    S1 --&gt; R1
    S2 --&gt; R1
    S3 --&gt; R2
    S4 --&gt; ST1
    S4 --&gt; ST2
    S4 --&gt; ST3
</div><h3 id="42-ドラフトデータ構造">4.2 ドラフトデータ構造 </h3>
<div class="mermaid">flowchart LR
    subgraph Draft["Draftオブジェクト"]
        D1["municipalityId: string"]
        D2["service: string"]
        D3["status: DraftStatus"]
        D4["variables: DraftVariableEntry[]"]
        D5["searchAttempts: Record"]
        D6["missingSuggestions: Record"]
        D7["createdAt: ISO8601"]
        D8["approvedAt?: ISO8601"]
    end

    subgraph Entry["DraftVariableEntry"]
        E1["name: string"]
        E2["value: string"]
        E3["confidence: 0-1"]
        E4["sourceUrl?: string"]
        E5["sourceSnippet?: string"]
    end

    subgraph Status["DraftStatus"]
        S1["pending_review"]
        S2["approved"]
        S3["rejected"]
    end

    D4 --&gt; E1
    D4 --&gt; E2
    D4 --&gt; E3
    D4 --&gt; E4
    D4 --&gt; E5
    D3 --&gt; S1
    D3 --&gt; S2
    D3 --&gt; S3
</div><hr>
<h2 id="5-テンプレート変数システム">5. テンプレート・変数システム </h2>
<h3 id="51-テンプレートクローン処理">5.1 テンプレートクローン処理 </h3>
<div class="mermaid">flowchart TD
    subgraph API["API - app/api/admin/municipalities/route.ts"]
        A1["POST /api/admin/municipalities"]
    end

    subgraph Clone["クローン処理 - lib/template/clone.ts"]
        C1["cloneTemplate(input, options)"]
        C2["getAllFiles(templateDir)&lt;br/&gt;再帰取得"]
        C3["replaceVariables()&lt;br/&gt;各ファイル置換"]
        C4["mkdir + writeFile&lt;br/&gt;ファイル作成"]
        C5["extractTemplateVariables()"]
        C6["getMunicipalityPageCount()"]
        C7["deleteMunicipality()"]
        C8["getTotalVariableCount()"]
    end

    subgraph Output["出力"]
        O1["meta.json&lt;br/&gt;自治体メタデータ"]
        O2["variables.json&lt;br/&gt;変数ストア"]
        O3["services/**/*.json&lt;br/&gt;サービスページ"]
    end

    A1 --&gt; C1
    C1 --&gt; C2
    C2 --&gt; C3
    C3 --&gt; C4
    C4 --&gt; O1
    C4 --&gt; O2
    C4 --&gt; O3
    C5 --&gt; C1
    C6 --&gt; C1
</div><h3 id="52-自治体データ管理">5.2 自治体データ管理 </h3>
<div class="mermaid">flowchart LR
    subgraph Storage["ストレージ操作 - lib/template/storage.ts"]
        S1["getMunicipalities()&lt;br/&gt;一覧取得"]
        S2["getMunicipality(id)&lt;br/&gt;単体取得"]
        S3["getMunicipalityMeta(id)&lt;br/&gt;メタ読込"]
        S4["getVariableStore(id)&lt;br/&gt;変数読込"]
        S5["updateVariableStore(id, vars)&lt;br/&gt;変数更新"]
        S6["updateMunicipalityMeta(id, meta)&lt;br/&gt;メタ更新"]
        S7["updateMunicipalityStatus(id, status)&lt;br/&gt;ステータス変更"]
    end

    subgraph District["地区依存変数 - lib/template/district-variables.ts"]
        D1["getDistrictVariables()"]
        D2["isDistrictDependentVariable()"]
    end

    subgraph Files["ファイル構造"]
        F1["data/artifacts/{id}/meta.json"]
        F2["data/artifacts/{id}/variables/*.json"]
        F3["data/artifacts/{id}/services/**/*.json"]
    end

    S1 --&gt; F1
    S3 --&gt; F1
    S4 --&gt; F2
    S5 --&gt; F2
    S6 --&gt; F1
    D1 --&gt; F2
</div><hr>
<h2 id="6-管理画面フロー">6. 管理画面フロー </h2>
<h3 id="61-ページ構成">6.1 ページ構成 </h3>
<div class="mermaid">flowchart TD
    subgraph Layout["レイアウト"]
        L1["app/admin/layout.tsx&lt;br/&gt;認証保護"]
    end

    subgraph Pages["ページ"]
        P1["app/admin/page.tsx&lt;br/&gt;ダッシュボード"]
        P2["app/admin/municipalities/page.tsx&lt;br/&gt;自治体一覧"]
        P3["app/admin/municipalities/new/page.tsx&lt;br/&gt;新規作成"]
        P4["app/admin/municipalities/[id]/page.tsx&lt;br/&gt;詳細・編集"]
        P5["app/admin/drafts/page.tsx&lt;br/&gt;ドラフト一覧"]
        P6["app/admin/drafts/[municipalityId]/[service]/page.tsx&lt;br/&gt;ドラフト詳細"]
        P7["app/admin/notifications/page.tsx&lt;br/&gt;通知一覧"]
    end

    subgraph Components["コンポーネント"]
        C1["FetchButton&lt;br/&gt;情報取得開始"]
        C2["PublishButton&lt;br/&gt;公開切替"]
        C3["VariableTable&lt;br/&gt;変数編集"]
        C4["ServiceVariableStats&lt;br/&gt;統計表示"]
        C5["HistoryTable&lt;br/&gt;履歴表示"]
        C6["VariableContextViewer&lt;br/&gt;コンテキスト"]
        C7["TemplatePreview&lt;br/&gt;プレビュー"]
        C8["SourceViewer&lt;br/&gt;ソース表示"]
        C9["DraftActions&lt;br/&gt;承認/却下"]
    end

    L1 --&gt; P1
    L1 --&gt; P2
    L1 --&gt; P3
    L1 --&gt; P4
    L1 --&gt; P5
    L1 --&gt; P6
    L1 --&gt; P7
    P4 --&gt; C1
    P4 --&gt; C2
    P4 --&gt; C3
    P4 --&gt; C4
    P4 --&gt; C5
    P6 --&gt; C6
    P6 --&gt; C7
    P6 --&gt; C8
    P6 --&gt; C9
</div><h3 id="62-管理api">6.2 管理API </h3>
<div class="mermaid">flowchart LR
    subgraph Municipality["自治体API"]
        M1["POST /api/admin/municipalities&lt;br/&gt;作成"]
        M2["GET /api/admin/municipalities&lt;br/&gt;一覧"]
        M3["GET /api/admin/municipalities/[id]&lt;br/&gt;詳細"]
        M4["PUT /api/admin/municipalities/[id]&lt;br/&gt;更新"]
        M5["DELETE /api/admin/municipalities/[id]&lt;br/&gt;削除"]
    end

    subgraph Fetch["取得API"]
        F1["POST /api/admin/municipalities/[id]/fetch&lt;br/&gt;取得開始(SSE)"]
        F2["GET /api/admin/municipalities/[id]/fetch/status&lt;br/&gt;ステータス"]
    end

    subgraph Variables["変数API"]
        V1["PUT /api/admin/municipalities/[id]/variables&lt;br/&gt;変数更新"]
    end

    subgraph History["履歴API"]
        H1["GET /api/admin/municipalities/[id]/history&lt;br/&gt;履歴取得"]
    end

    subgraph Drafts["ドラフトAPI"]
        D1["GET /api/admin/drafts&lt;br/&gt;一覧"]
        D2["GET /api/admin/drafts/[municipalityId]/[service]&lt;br/&gt;詳細"]
        D3["PUT /api/admin/drafts/[municipalityId]/[service]&lt;br/&gt;更新"]
        D4["DELETE /api/admin/drafts/[municipalityId]/[service]&lt;br/&gt;削除"]
        D5["GET .../template&lt;br/&gt;テンプレートプレビュー"]
        D6["GET .../source&lt;br/&gt;ソースドキュメント"]
    end

    subgraph Utils["ユーティリティAPI"]
        U1["POST /api/admin/pdf/ocr&lt;br/&gt;PDF OCR"]
        U2["GET /api/admin/notifications&lt;br/&gt;通知一覧"]
    end
</div><hr>
<h2 id="7-ストレージ抽象化層">7. ストレージ抽象化層 </h2>
<div class="mermaid">flowchart TD
    subgraph Factory["ファクトリ - lib/storage/index.ts"]
        F1["createStorageAdapter(config)"]
        F2["getDefaultStorageAdapter()&lt;br/&gt;シングルトン"]
    end

    subgraph Interface["インターフェース - lib/storage/types.ts"]
        I1["ArtifactStorageAdapter"]
        I2["get(key): Promise&lt;string&gt;"]
        I3["put(key, value): Promise&lt;void&gt;"]
        I4["delete(key): Promise&lt;void&gt;"]
        I5["list(prefix): Promise&lt;string[]&gt;"]
    end

    subgraph Adapters["アダプタ実装"]
        A1["LocalAdapter&lt;br/&gt;lib/storage/local-adapter.ts"]
        A2["S3Adapter&lt;br/&gt;lib/storage/s3-adapter.ts"]
    end

    subgraph Config["設定"]
        C1["ARTIFACT_STORAGE_TYPE=local"]
        C2["ARTIFACT_STORAGE_TYPE=s3"]
        C3["ARTIFACT_STORAGE_TYPE=r2"]
    end

    F1 --&gt; I1
    F2 --&gt; F1
    I1 --&gt; I2
    I1 --&gt; I3
    I1 --&gt; I4
    I1 --&gt; I5
    I1 --&gt; A1
    I1 --&gt; A2
    C1 --&gt; A1
    C2 --&gt; A2
    C3 --&gt; A2
</div><hr>
<h2 id="8-コンポーネント階層">8. コンポーネント階層 </h2>
<h3 id="81-blockレンダリング">8.1 Blockレンダリング </h3>
<div class="mermaid">flowchart TD
    subgraph Renderer["メインレンダラー"]
        BR1["BlockRenderer.tsx"]
        BR2["MunicipalityContext.tsx"]
    end

    subgraph Blocks["ブロックカテゴリ"]
        B1["ContentBlocks.tsx&lt;br/&gt;Title/Summary/RichText&lt;br/&gt;Table/Accordion/Section"]
        B2["NavigationBlocks.tsx&lt;br/&gt;Breadcrumbs/ResourceList&lt;br/&gt;RelatedLinks"]
        B3["InteractiveBlocks.tsx&lt;br/&gt;Contact/ActionButton&lt;br/&gt;TaskButton/StepNavigation&lt;br/&gt;DirectoryList"]
        B4["NotificationBlocks.tsx&lt;br/&gt;NotificationBanner&lt;br/&gt;EmergencyBanner"]
        B5["HomePageBlocks.tsx&lt;br/&gt;Hero/TopicGrid/TopicList&lt;br/&gt;QuickLinks/NewsList"]
    end

    subgraph Special["特殊ブロック"]
        S1["DistrictSelector / HazardMapViewer"]
        S2["ShelterList / InfoCard / CardGrid"]
        S3["Attachments / Sources"]
    end

    subgraph Utils["ユーティリティ"]
        U1["RichTextRenderer.tsx"]
        U2["BudouX.tsx"]
    end

    BR1 --&gt; BR2
    BR2 --&gt; Blocks
    BR2 --&gt; Special
    B1 --&gt; U1
    U1 --&gt; U2
</div><h3 id="82-dadsコンポーネント">8.2 DADSコンポーネント </h3>
<div class="mermaid">flowchart LR
    subgraph DADS["components/dads/index.ts - 50+コンポーネント"]
        L["レイアウト&lt;br/&gt;Accordion/Breadcrumbs/Disclosure&lt;br/&gt;Divider/Dl/Ol/Ul/Blockquote/Slot"]
        F["フォーム&lt;br/&gt;Input/Textarea/Select&lt;br/&gt;Checkbox/Radio/DatePicker"]
        B["ボタン&lt;br/&gt;Button/HamburgerMenuButton&lt;br/&gt;UtilityLink"]
        I["情報表示&lt;br/&gt;Label/Legend/ErrorText/SupportText&lt;br/&gt;StatusBadge/RequirementBadge&lt;br/&gt;ResourceList/NotificationBanner&lt;br/&gt;EmergencyBanner/Carousel"]
        N["ナビゲーション&lt;br/&gt;LanguageSelector/StepNavigation"]
    end
</div><hr>
<h2 id="9-認証ミドルウェア">9. 認証・ミドルウェア </h2>
<div class="mermaid">flowchart TD
    subgraph Middleware["middleware.ts"]
        M1["リクエスト受信"]
        M2["パスチェック"]
        M3["Basic認証チェック"]
        M4["Bearer認証チェック"]
        M5["認証成功"]
        M6["401 Unauthorized"]
    end

    subgraph Routes["保護ルート"]
        R1["/admin/*"]
        R2["/api/admin/*"]
        R3["/api/cron/update-municipalities"]
    end

    subgraph Auth["認証方式"]
        A1["Basic Auth&lt;br/&gt;ADMIN_BASIC_AUTH"]
        A2["Bearer Token&lt;br/&gt;CRON_SECRET"]
    end

    M1 --&gt; M2
    M2 --&gt;|/admin| R1
    M2 --&gt;|/api/admin| R2
    M2 --&gt;|/api/cron| R3
    R1 --&gt; M3
    R2 --&gt; M3
    R3 --&gt; M4
    M3 --&gt;|有効| M5
    M3 --&gt;|無効| M6
    M4 --&gt;|有効| M5
    M4 --&gt;|無効| M6
    A1 --&gt; M3
    A2 --&gt; M4
</div><hr>
<h2 id="10-未使用参照用コード">10. 未使用・参照用コード </h2>
<h3 id="101-アーカイブ使用禁止">10.1 アーカイブ（使用禁止） </h3>
<div class="mermaid">flowchart LR
    subgraph Archive["archive/ - 使用禁止"]
        A1["archive/docs/&lt;br/&gt;古いドキュメント"]
        A2["archive/scrapers/&lt;br/&gt;旧スクレイピングパイプライン"]
        A3["archive/processors/&lt;br/&gt;旧データ処理"]
    end

    subgraph Warning["警告"]
        W1["CLAUDE.mdで参照禁止"]
        W2["レガシーコード"]
        W3["互換性なし"]
    end

    A1 --&gt; W1
    A2 --&gt; W2
    A3 --&gt; W3
</div><h3 id="102-開発テスト用本番未使用">10.2 開発・テスト用（本番未使用） </h3>
<table>
<thead>
<tr>
<th>カテゴリ</th>
<th>パス</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>開発ルート</td>
<td><code>app/dev/dads/</code></td>
<td>DADSコンポーネントショーケース</td>
</tr>
<tr>
<td></td>
<td><code>app/dev/review/</code></td>
<td>コンテンツレビューUI</td>
</tr>
<tr>
<td></td>
<td><code>app/dev/structure/</code></td>
<td>構造検査</td>
</tr>
<tr>
<td>スクリプト</td>
<td><code>scripts/test-*.ts</code></td>
<td>各種テストスクリプト</td>
</tr>
<tr>
<td></td>
<td><code>scripts/validate-artifacts.ts</code></td>
<td>スキーマ検証</td>
</tr>
<tr>
<td></td>
<td><code>scripts/build-search-index.ts</code></td>
<td>検索インデックス構築</td>
</tr>
<tr>
<td>参照用関数</td>
<td><code>lib/llm/prompts/content-structurer.ts</code></td>
<td>COMPONENT_SELECTION_RULES</td>
</tr>
<tr>
<td></td>
<td><code>lib/llm/prompts/missing-variable-suggester.ts</code></td>
<td>不足変数提案</td>
</tr>
</tbody>
</table>
<h3 id="103-ジョブ管理内部使用">10.3 ジョブ管理（内部使用） </h3>
<table>
<thead>
<tr>
<th>関数</th>
<th>役割</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>createFetchJob()</code></td>
<td>ジョブ作成</td>
</tr>
<tr>
<td><code>saveJob()</code></td>
<td>状態保存</td>
</tr>
<tr>
<td><code>getLatestJob()</code></td>
<td>最新取得</td>
</tr>
<tr>
<td><code>updateServiceStatus()</code></td>
<td>進捗更新</td>
</tr>
<tr>
<td><code>recordJobError()</code></td>
<td>エラー記録</td>
</tr>
<tr>
<td><code>completeJob()</code></td>
<td>完了処理</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>ストレージ</strong>: <code>data/artifacts/_jobs/{id}/latest.json</code></li>
<li><strong>用途</strong>: 長時間実行タスクの再開、進捗トラッキング、エラー復旧</li>
</ul>
<h3 id="104-履歴通知補助機能">10.4 履歴・通知（補助機能） </h3>
<table>
<thead>
<tr>
<th>モジュール</th>
<th>関数</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lib/history/storage.ts</code></td>
<td><code>addHistoryEntry()</code></td>
<td>監査証跡</td>
</tr>
<tr>
<td></td>
<td><code>recordVariableUpdate()</code></td>
<td>変更追跡</td>
</tr>
<tr>
<td></td>
<td><code>recordBulkVariableUpdate()</code></td>
<td>変更追跡</td>
</tr>
<tr>
<td></td>
<td><code>recordDraftApproval()</code></td>
<td>監査証跡</td>
</tr>
<tr>
<td></td>
<td><code>recordDraftRejection()</code></td>
<td>監査証跡</td>
</tr>
<tr>
<td></td>
<td><code>getHistoryList()</code></td>
<td>監査証跡</td>
</tr>
<tr>
<td></td>
<td><code>getHistoryStats()</code></td>
<td>監査証跡</td>
</tr>
<tr>
<td><code>lib/notification/storage.ts</code></td>
<td><code>createNotification()</code></td>
<td>管理者通知</td>
</tr>
<tr>
<td></td>
<td><code>getNotifications()</code></td>
<td>管理者通知</td>
</tr>
<tr>
<td></td>
<td><code>deleteNotification()</code></td>
<td>管理者通知</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="付録-ファイル一覧と主要エクスポート">付録: ファイル一覧と主要エクスポート </h2>
<h3 id="コアライブラリ">コアライブラリ </h3>
<table>
<thead>
<tr>
<th>ファイルパス</th>
<th>主要エクスポート</th>
<th>役割</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lib/artifact/index.ts</code></td>
<td><code>loadArtifact</code>, <code>loadArtifacts</code>, <code>getCompletedPages</code></td>
<td>アーティファクト読込インターフェース</td>
</tr>
<tr>
<td><code>lib/artifact/loader.ts</code></td>
<td><code>loadArtifactInternal</code></td>
<td>キャッシュ付き読込実装</td>
</tr>
<tr>
<td><code>lib/artifact/schema.ts</code></td>
<td><code>validateArtifact</code>, <code>safeValidateArtifact</code></td>
<td>Zodスキーマ検証</td>
</tr>
<tr>
<td><code>lib/artifact/cache.ts</code></td>
<td><code>getFromCache</code>, <code>setInCache</code>, <code>invalidateCache</code></td>
<td>インメモリキャッシュ</td>
</tr>
<tr>
<td><code>lib/template/clone.ts</code></td>
<td><code>cloneTemplate</code>, <code>deleteMunicipality</code></td>
<td>テンプレート複製</td>
</tr>
<tr>
<td><code>lib/template/replace.ts</code></td>
<td><code>replaceVariables</code>, <code>replaceVariablesWithSources</code></td>
<td>変数置換</td>
</tr>
<tr>
<td><code>lib/template/storage.ts</code></td>
<td><code>getMunicipalities</code>, <code>getVariableStore</code>, <code>updateVariableStore</code></td>
<td>自治体データCRUD</td>
</tr>
<tr>
<td><code>lib/llm/fetcher.ts</code></td>
<td><code>fetchServiceVariables</code></td>
<td>LLM取得オーケストレーション</td>
</tr>
<tr>
<td><code>lib/llm/gemini.ts</code></td>
<td><code>generateContent</code>, <code>generateJSON</code></td>
<td>Gemini APIクライアント</td>
</tr>
<tr>
<td><code>lib/llm/google-search.ts</code></td>
<td><code>googleSearch</code>, <code>searchMunicipalitySite</code></td>
<td>Google検索</td>
</tr>
<tr>
<td><code>lib/llm/page-fetcher.ts</code></td>
<td><code>fetchPage</code>, <code>fetchPageWithPdfs</code></td>
<td>コンテンツ取得</td>
</tr>
<tr>
<td><code>lib/llm/validators.ts</code></td>
<td><code>validateVariable</code>, <code>validatePhone</code>, etc.</td>
<td>値検証</td>
</tr>
<tr>
<td><code>lib/drafts/storage.ts</code></td>
<td><code>getAllDrafts</code>, <code>getDraft</code>, <code>saveDraft</code></td>
<td>ドラフトCRUD</td>
</tr>
<tr>
<td><code>lib/drafts/diff.ts</code></td>
<td><code>compareDraftWithStore</code>, <code>applyDraftToStore</code></td>
<td>差分比較・適用</td>
</tr>
<tr>
<td><code>lib/storage/index.ts</code></td>
<td><code>createStorageAdapter</code>, <code>getDefaultStorageAdapter</code></td>
<td>ストレージファクトリ</td>
</tr>
</tbody>
</table>
<h3 id="コンポーネント">コンポーネント </h3>
<table>
<thead>
<tr>
<th>ファイルパス</th>
<th>主要エクスポート</th>
<th>役割</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>components/blocks/BlockRenderer.tsx</code></td>
<td><code>BlockRenderer</code></td>
<td>ブロック振り分け</td>
</tr>
<tr>
<td><code>components/blocks/MunicipalityContext.tsx</code></td>
<td><code>MunicipalityProvider</code>, <code>useMunicipality</code></td>
<td>コンテキスト</td>
</tr>
<tr>
<td><code>components/blocks/RichTextRenderer.tsx</code></td>
<td><code>RichTextRenderer</code></td>
<td>リッチテキスト解析</td>
</tr>
<tr>
<td><code>components/dads/index.ts</code></td>
<td>50+コンポーネント</td>
<td>DADSライブラリ</td>
</tr>
</tbody>
</table>
<hr>
<p><em>このドキュメントは2026-02-02に更新されました。</em></p>

      </div>
      
      
    
    
    <script type="module">
// TODO: If ZenUML gets integrated into mermaid in the future,
//      we can remove the following lines.


var MERMAID_CONFIG = ({"startOnLoad":false});
if (typeof MERMAID_CONFIG !== 'undefined') {
  MERMAID_CONFIG.startOnLoad = false
  MERMAID_CONFIG.cloneCssStyles = false
  MERMAID_CONFIG.theme = "default"
}

mermaid.initialize(MERMAID_CONFIG || {})
if (typeof(window['Reveal']) !== 'undefined') {
  function mermaidRevealHelper(event) {
    var currentSlide = event.currentSlide
    var diagrams = currentSlide.querySelectorAll('.mermaid')
    for (var i = 0; i < diagrams.length; i++) {
      var diagram = diagrams[i]
      if (!diagram.hasAttribute('data-processed')) {
        mermaid.init(null, diagram, ()=> {
          Reveal.slide(event.indexh, event.indexv)
        })
      }
    }
  }
  Reveal.addEventListener('slidetransitionend', mermaidRevealHelper)
  Reveal.addEventListener('ready', mermaidRevealHelper)
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
} else {
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
}
</script>
    
    
    
  
    </body></html>