# 2026-02-02 更新履歴

## ドキュメント更新

### INNOMA_FLOWCHART.md リファクタリング
- セクション3.3: バリデータノード (V1-V8) を1つに統合、接続線を削減
- セクション3.4: 15個のサービスカテゴリノードを1つの纏めノードに統合
- セクション8.1: 約30個のブロックノードをカテゴリ別に5グループに統合
- セクション8.2: DADSコンポーネントのネスト構造を簡略化
- セクション10.2-10.4: mermaidフローチャートを表形式に変換

## リファクタリング

### lib/template/replace.ts
- 重複していた `validators` オブジェクトを削除
- `lib/llm/validators.ts` の関数をインポートしてラッパーとして提供
- `inferValidator()`, `validateVariableValue()` を `@deprecated` としてマーク

### lib/llm/google-search.ts
- 3箇所で重複していた fallback パターンを `executeWithFallback()` 関数に統合
- `googleSearch()`, `searchMunicipalitySite()`, `searchServiceInfo()` をシンプル化
- 約60行のコード削減

### components/blocks/RichTextRenderer.tsx
- `containsUnresolvedVariable()` と `nodeContainsUnresolvedVariable()` を統合
- `hasUnresolvedVariable()` 関数として TypeScript のオーバーロードパターンで実装
- 正規表現パターンを定数化 (`UNRESOLVED_VARIABLE_PATTERN`)

### lib/llm/types.ts
- 後方互換性のための re-export に `@deprecated` JSDoc コメントを追加
- `SearchAttemptRecord`, `DraftVariable` の移行先を明示

## ドキュメント同期（実装との整合性更新）

### PROJECT.md
- 最終更新日を2026-02-02に更新
- 技術スタック: Brave Search API、Playwrightを追加
- Phase 6（高度な情報取得）を追加
- LLM情報取得ファイル一覧を拡充（brave-search.ts, playwright-crawler.ts, deep-search.ts, validators.ts）
- 環境変数: Brave Search関連、SEARCH_PROVIDER設定を追加
- LLM情報取得フロー: デュアルプロバイダー、Playwright、具体性判定を追加

### API_REFERENCE.md
- 最終更新日を2026-02-02に更新
- ドラフトAPIパスを実装に合わせて修正（`[municipalityId]/[service]`形式）
- 地区依存変数API（`/api/districts`）を追加
- コンテンツ生成API（`/api/admin/generate`）を追加
- ドラフトソース・テンプレートAPIを追加

### LLM_FETCHER_SPEC.md
- 最終更新日を2026-02-02に更新
- セクション12: Playwrightクローラーを追加
- セクション13: 値の具体性判定を追加
- 今後の検討事項: 完了項目を更新

### ADMIN_PANEL_SPEC.md
- 最終更新日を2026-02-02に更新
- 認証方式: Basic認証（middleware.ts）、Cron認証を追記
- 画面構成: /generateを追加

### DATA_STRUCTURES.md
- 最終更新日を2026-02-02に更新
- ディレクトリ構造: variables/サブディレクトリを追加
- セクション10: 地区依存変数を追加

### TEMPLATE_VARIABLES.md
- 最終更新日を2026-02-02に更新
- 総変数数の動的計算について記載
- セクション5: validationType列を追加、postal/count/textタイプを追加
- セクション6: 地区依存変数を追加
- セクション7: 変数ストアのカテゴリ別ファイル構造を追加

## ドキュメント構成の再編成

### フォルダ構成の新設
- `docs/specs/` - 仕様書（API, Admin, LLM, UI, Data）
- `docs/guides/` - 開発ガイド（変数、コンポーネント、DADS）
- `docs/architecture/` - アーキテクチャ図（フローチャート）
- `docs/reports/` - 自治体レポート

### ファイル移動
**specs/**
- API_REFERENCE.md
- ADMIN_PANEL_SPEC.md
- LLM_FETCHER_SPEC.md
- UI_SPEC.md
- DATA_STRUCTURES.md

**guides/**
- TEMPLATE_VARIABLES.md
- DISTRICT_DEPENDENT_VARIABLES.md
- COMPONENT_SELECTION_LOGIC.md
- DADS_COMPONENTS.md

**architecture/**
- INNOMA_FlowChart.md
- FETCH_TO_SHOW_FLOWCHART.md

**reports/**
- MUNICIPALITY_VARIABLE_REPORT.md
- TSURU_VARIABLE_REPORT.md
- OTAKI_VARIABLE_REPORT.md
- HIGASHIYOSHINO_VARIABLE_REPORT.md
- KITAGAWA_VARIABLE_REPORT.md
- VARIABLE_REVIEW_NOTES.md

### 参照パス更新
- CLAUDE.md: ドキュメント参照テーブルのパスを新構成に更新
- PROJECT.md: ディレクトリ構造、参照リンクを新構成に更新

### インデックス作成
- docs/README.md: ドキュメント全体のインデックスを新規作成
