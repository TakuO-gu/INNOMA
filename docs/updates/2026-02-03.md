# 2026-02-03 更新履歴

## 新機能追加

### GOV.UK方式フラットURL + タクソノミー分離の導入

GOV.UKのURL設計思想を参考に、INNOMAのURL構造を刷新しました。

#### 変更内容

**URL構造の変更（Content Item）:**
```
旧: /takaoka/services/health/kokuho
新: /takaoka/kokuho
```

**トピックページもフラット化:**
```
旧: /takaoka/topics/health
新: /takaoka/health
```

**タクソノミー（分類）をURLから分離:**
- URLに分類情報を含めない
- メタデータ（page-registry.json）で管理
- 1ページが複数カテゴリに属することが可能に

#### 新規ファイル

| ファイル | 説明 |
|---------|------|
| `apps/web/data/artifacts/_templates/page-registry.json` | ページスラッグ→ファイルパスのマッピング（121エントリ: Content Item 106 + Topic 15） |
| `apps/web/lib/artifact/page-registry.ts` | レジストリ読み込み・解決ロジック |
| `scripts/migrate-flat-urls.ts` | データ移行スクリプト |

#### 変更ファイル

| ファイル | 変更内容 |
|---------|----------|
| `apps/web/app/[municipality]/[[...path]]/page.tsx` | `buildArtifactKey()`にpage-registry参照を追加 |
| `apps/web/lib/artifact/loader.ts` | `getCompletedPages()`をフラットURL対応に更新 |
| `apps/web/lib/artifact/innoma-artifact-schema.v2.ts` | `taxonomy`フィールドを追加（オプショナル） |

#### データ移行

移行スクリプトにより以下を自動変換:
- **368ファイル**を処理
- **1966個のhref参照**をフラット化（Content Item）
- **402個のhref参照**をフラット化（Topic）
- **318個のpathフィールド**を更新

#### GOV.UK方式の特徴

1. **フラットURL**: ユーザーが覚えやすく、共有しやすい
2. **タクソノミー分離**: URLとコンテンツ分類を独立して管理
3. **後方互換性**: 旧形式（/services/category/page, /topics/category）も引き続きサポート
4. **拡張性**: 1ページ複数カテゴリ対応の基盤を整備

---

### 用語変更: サービスページ → Content Item

ディレクトリ階層がなくなったため、末端ページの呼称を変更しました。

| 旧用語 | 新用語 | 説明 |
|--------|--------|------|
| サービスページ | Content Item | 末端の個別ページ（例: 国保、住民票） |
| トピックページ | Topic | カテゴリ一覧ページ（例: 健康、届出） |

**変更ファイル:**
- `CLAUDE.md` - チェックリスト名を変更
- `docs/guides/COMPONENT_SELECTION_LOGIC.md`
- `docs/guides/TEMPLATE_VARIABLES.md`
- `docs/guides/THREE_COLUMN_LAYOUT.md`
- `docs/guides/DADS_COMPONENTS.md`
- `docs/architecture/INNOMA_FlowChart.md`

---

### トップページのトピック表示を7つに制限

トップページに表示するトピックを以下の7つに絞り込みました：

| トピック | スラッグ | 説明 |
|---------|---------|------|
| 災害・緊急情報 | `/disaster` | 避難所、ハザードマップ、防災メール |
| 問い合わせ先一覧 | `/contacts` | 各課窓口、電話番号、受付時間 |
| 引っ越し | `/moving` | 転入届、転出届、転居届 |
| 子育て・出産 | `/childcare` | 妊娠届、出生届、児童手当、保育所 |
| 高齢者向け支援 | `/welfare` | 介護保険、高齢者福祉サービス |
| ごみ・リサイクル | `/environment` | ごみの分別、収集日、粗大ごみ |
| 税金・保険料 | `/tax` | 住民税、固定資産税、国保、介護保険料 |

**新規作成ファイル:**
- `apps/web/data/artifacts/_templates/topics/contacts.json`
- `apps/web/data/artifacts/_templates/topics/moving.json`

**変更ファイル:**
- `apps/web/data/artifacts/_templates/index.json` - TopicGrid更新
- `apps/web/data/artifacts/_templates/page-registry.json` - contacts, moving追加
- `apps/web/data/artifacts/takaoka/index.json` - TopicGrid更新
- `apps/web/data/artifacts/takaoka/topics/contacts.json` - 新規
- `apps/web/data/artifacts/takaoka/topics/moving.json` - 新規

---

### LLMタクソノミー分類機能の追加

GOV.UK方式のタクソノミー分類をLLMで自動化する機能を追加しました。

#### 機能概要

- Content Itemのタイトル・説明・キーワードからカテゴリを自動推論
- プライマリカテゴリ + セカンダリカテゴリ（最大2つ）を提案
- LLMが使えない環境向けにキーワードベースの簡易分類も提供
- page-registry.jsonの自動更新

#### 新規ファイル

| ファイル | 説明 |
|---------|------|
| `apps/web/lib/llm/prompts/taxonomy-classifier.ts` | LLMタクソノミー分類プロンプト・ロジック |
| `scripts/taxonomy-classifier.ts` | CLIスクリプト |

#### 使用方法

```bash
# 全ページを分類（LLM使用）
npx tsx scripts/taxonomy-classifier.ts

# 特定ページのみ
npx tsx scripts/taxonomy-classifier.ts --slug kokuho

# プレビュー（変更なし）
npx tsx scripts/taxonomy-classifier.ts --dry-run

# キーワードベース分類（LLMなし）
npx tsx scripts/taxonomy-classifier.ts --no-llm
```

#### タクソノミー定義

INNOMAでは15のメインカテゴリを定義:

| カテゴリ | 日本語名 | 説明 |
|---------|---------|------|
| registration | 届出・証明 | 戸籍、住民票、印鑑登録など |
| childcare | 子育て・出産 | 妊娠、出産、保育所、児童手当など |
| welfare | 福祉・介護 | 高齢者福祉、介護保険、障害者支援など |
| health | 健康・医療 | 国民健康保険、健診、予防接種など |
| tax | 税金 | 住民税、固定資産税、納税など |
| environment | 環境・ごみ | ごみの分別・収集、リサイクルなど |
| housing | 住まい・土地 | 住宅、公営住宅、空き家など |
| disaster | 防災・安全 | 避難所、ハザードマップ、防犯など |
| business | 産業・事業者 | 起業、融資、補助金など |
| employment | 就労・雇用 | 就職支援、労働相談など |
| driving | 自動車・運転 | 運転免許、車検、駐車場など |
| nationality | 国籍・在留 | 外国人登録、在留資格など |
| civic | 市民参加・行政 | 選挙、情報公開、市民相談など |
| land | 農林水産 | 農業、林業、漁業など |
| benefits | 給付・助成 | 各種給付金、助成金、年金など |

#### エクスポート

`apps/web/lib/llm/index.ts` から以下をエクスポート:
- `classifyContent` - 単一コンテンツの分類
- `classifyContentBatch` - 複数コンテンツの一括分類
- `classifyByKeywords` - キーワードベース分類（LLMなし）
- `INNOMA_TAXONOMY` - タクソノミー定義
- `TaxonomyCategory`, `TaxonomyClassification` 型

---

### Content Item作成ガイドの追加

GOV.UK方式のページタイプ定義をドキュメント化しました。

**新規ファイル:**
- `docs/guides/CONTENT_ITEM_CREATION.md`

**変更ファイル:**
- `CLAUDE.md` - Content Item作成ガイドへのリンクを追加

---

### スキーマの簡素化（GOV.UK方式の3タイプ）

`content_type`を3つに限定し、`service_category`を柔軟な文字列型に変更しました。

#### content_type の変更

| 旧値 | 新値 | 説明 |
|-----|-----|------|
| service, form | **service** | 行動ページ: 申請・登録・支払い等を促す |
| guide, step_by_step, contact, news, directory, other | **guide** | 理解ページ: 制度・仕組みを説明する |
| (新規) | **answer** | 判定ページ: 対象かどうかをYes/Noで判定 |

#### service_category の変更

- 旧: enum型（10種類固定）
- 新: string型（タクソノミーから柔軟に設定可能）

#### 削除されたフィールド

- `topic` タグ（emergency, seasonal, covid, digital）を削除

#### 変更ファイル

| ファイル | 変更内容 |
|---------|----------|
| `apps/web/lib/artifact/innoma-artifact-schema.v2.ts` | ContentType, ServiceCategory, Skeletons, CONTENT_TYPE_GUIDE を更新 |
| `apps/web/lib/artifact/schema.ts` | Topic参照を削除 |

#### 後方互換性

`LEGACY_CONTENT_TYPE_MAP` を追加して旧content_type値から新値へのマッピングを提供

---

### 22自治体へのテンプレート一括コピー

不完全なデータを持つ22自治体に、テンプレートからコンテンツをコピーしました。

#### 対象自治体（22自治体）

| ID | 自治体名 | 都道府県 |
|----|---------|---------|
| atami | 熱海市 | 静岡県 |
| choshi | 銚子市 | 千葉県 |
| hakone | 箱根町 | 神奈川県 |
| hayakawa | 早川町 | 山梨県 |
| higashiyoshino | 東吉野村 | 奈良県 |
| ide | 井手町 | 京都府 |
| kamikitayama | 上北山村 | 奈良県 |
| kanna | 神流町 | 群馬県 |
| kawachi | 河内町 | 茨城県 |
| kawasaki-miyagi | 川崎町 | 宮城県 |
| kitagawa | 北川村 | 高知県 |
| kusatsu | 草津町 | 群馬県 |
| nanmoku | 南牧村 | 群馬県 |
| nosegawa | 野迫川村 | 奈良県 |
| otaki | 王滝村 | 長野県 |
| shimoichi | 下市町 | 奈良県 |
| sotogahama | 外ヶ浜町 | 青森県 |
| tobetsu | 当別町 | 北海道 |
| toyono | 豊能町 | 大阪府 |
| utashinai | 歌志内市 | 北海道 |
| yoshimi | 吉見町 | 埼玉県 |
| yoshino | 吉野町 | 奈良県 |

#### 作成したファイル

- 各自治体に **127-128個** のコンテンツファイル（JSON）をコピー
- 合計 **2793ファイル** を新規作成

#### 変換内容

テンプレートから以下を自動変換:
- `municipality_id`: "sample" → 各自治体ID
- `page_id`: "sample-xxx" → "{自治体ID}-xxx"
- `{{municipality_name}}`: → 各自治体名（例: "熱海市"）
- `{{generated_at}}`: → 現在のタイムスタンプ
- `source_url`: "template://sample/" → "template://{自治体ID}/"

#### 新規スクリプト

| ファイル | 説明 |
|---------|------|
| `scripts/copy-templates-to-municipalities.mjs` | テンプレート一括コピースクリプト |

#### 使用方法

```bash
# 全自治体にコピー
node scripts/copy-templates-to-municipalities.mjs

# 特定の自治体のみ
node scripts/copy-templates-to-municipalities.mjs atami
```

#### 注意事項

- 変数（`{{city_hall_phone}}`など）はテンプレートのまま
- 変数の実値は `variables/core.json` に保存
- 今後、LLM情報取得または管理画面から変数を更新可能

---

## データ更新

### 21自治体のcore.json変数追加

21自治体の `variables/core.json` に不足していた `city_hall_hours`（開庁時間）を追加しました。

#### 対象自治体

| 自治体ID | 自治体名 | 開庁時間 |
|---------|---------|---------|
| choshi | 銚子市 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| hakone | 箱根町 | 8時30分～17時15分（月曜日～金曜日、土・日曜日、祝日、12月29日～1月3日を除く） |
| hayakawa | 早川町 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| higashiyoshino | 東吉野村 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| ide | 井手町 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| kamikitayama | 上北山村 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| kanna | 神流町 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| kawasaki-miyagi | 川崎町 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| kitagawa | 北川村 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| nanmoku | 南牧村 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| nosegawa | 野迫川村 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| otaki | 王滝村 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| shimoichi | 下市町 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| sotogahama | 外ヶ浜町 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| tobetsu | 当別町 | 午前8時30分から午後5時15分まで（土曜日、日曜日、祝日、年末年始を除く） |
| toyono | 豊能町 | 午前9時から午後5時30分まで（土曜日、日曜日、祝日、12月29日～1月3日を除く） |
| yoshimi | 吉見町 | 月曜日から金曜日（祝日及び年末年始を除く）午前8時30分から午後5時15分 |
| yoshino | 吉野町 | 午前8時30分から午後5時15分（祝日、休日、年末年始を除く月曜日から金曜日） |

**既に開庁時間があった自治体:**
- kawachi（河内町）: 平日：午前8時30分から午後5時15分まで（祝日・年末年始を除く）
- kusatsu（草津町）: 午前8時30分〜午後5時15分（土日祝日、年末年始を除く）
- utashinai（歌志内市）: 8時30分～17時15分（土日祝日、年末年始12月30日～1月4日を除く）

#### 変更ファイル

18自治体の `variables/core.json` に以下の変数を追加:
- `city_hall_hours`: 開庁時間
- `source`: "llm"
- `sourceUrl`: 各自治体の公式ウェブサイトURL
- `confidence`: 0.9-0.95
- `updatedAt`: "2026-02-03T00:00:00.000Z"

#### 情報取得方法

- 各自治体の公式ウェブサイトをBrave Searchで検索
- 市役所・役場のトップページ、組織情報ページから開庁時間を取得
- 多くの自治体で標準的な「平日8:30-17:15」を確認
- 豊能町のみ9:00-17:30と異なる開庁時間

#### 注意事項

- `city_hall_email`（代表メールアドレス）については、多くの自治体が公開していないため、今回は追加していません
- 自治体によっては問い合わせフォームのみ提供している場合があります

---

### 10自治体のcore.json変数追加（第2弾）

不足していた介護保険・税務・子育て支援・保険・環境担当部署の変数を追加しました。

#### 対象自治体と追加変数

| 自治体ID | 自治体名 | 追加変数 |
|---------|---------|---------|
| kanna | 神流町 | kaigo_department, kaigo_phone, tax_department, tax_phone, kosodate_department, kosodate_phone, hoken_department, hoken_phone, environment_department, environment_phone |
| kawachi | 河内町 | kaigo_department, kaigo_phone, tax_phone, kosodate_department, kosodate_phone, hoken_department, hoken_phone, environment_phone |
| kawasaki-miyagi | 川崎町 | kaigo_department, kaigo_phone, tax_phone, hoken_department, hoken_phone, environment_department, environment_phone |
| kusatsu | 草津町 | tax_department, tax_phone, welfare_department, welfare_phone, kaigo_department, kaigo_phone, hoken_department, hoken_phone, kosodate_department, kosodate_phone, environment_department, environment_phone, building_department, building_phone |
| nanmoku | 南牧村 | kaigo_department, kaigo_phone, tax_phone, registration_phone, kosodate_department, kosodate_phone, hoken_department, hoken_phone, environment_department, environment_phone |
| nosegawa | 野迫川村 | kaigo_department, kaigo_phone, welfare_department, welfare_phone, tax_department, tax_phone, registration_department, registration_phone, kosodate_department, kosodate_phone, hoken_department, hoken_phone, environment_department, environment_phone, housing_department, housing_phone |
| otaki | 王滝村 | kaigo_department, kaigo_phone, tax_department, tax_phone, kosodate_department, kosodate_phone, hoken_department, hoken_phone, environment_department, environment_phone |
| sotogahama | 外ヶ浜町 | kaigo_department, kaigo_phone, hoken_department, hoken_phone, kosodate_department, kosodate_phone, environment_department, environment_phone |
| toyono | 豊能町 | kaigo_department, kaigo_phone, zeimu_department, zeimu_phone |
| yoshino | 吉野町 | kaigo_department, kaigo_phone, tax_phone, kosodate_department, kosodate_phone, hoken_department, hoken_phone, building_department, building_phone, environment_phone |

#### 情報取得方法

小規模な町村では部署が統合されているケースが多いため、以下のように設定:

**神流町（kanna）:**
- 介護・子育て・保険・環境: すべて保健福祉課が担当
- 税務: 住民生活課が担当
- 電話番号: 代表（0274-57-2111）

**河内町（kawachi）:**
- 介護・子育て: 福祉課
- 保険・環境: 町民課
- 電話番号: 代表（0297-84-2111）

**川崎町（kawasaki-miyagi）:**
- 介護: 保健福祉課
- 保険・環境: 町民生活課（直通: 0224-84-2112）
- 税務: 代表（0224-84-2111）

**草津町（kusatsu）:**
- 住民課（愛町部）: 0279-88-7192
- 健康推進課: 介護・子育て担当
- 建設課: 建設部
- その他: 代表（0279-88-0001）

**南牧村（nanmoku）:**
- 保健福祉課: 介護・子育て・保険
- 住民税務課: 税務・環境
- 電話番号: すべて代表（0274-87-2011）

**野迫川村（nosegawa）:**
- 住民課が多数の係を統合（介護保険係、福祉係、税務係、戸籍係、国保係）
- 建設課: 住宅関連
- 電話番号: すべて同一（0747-37-2101）

**王滝村（otaki）:**
- 福祉健康課: 介護・子育て・保険（直通: 0264-48-3155）
- 総務課: 税務・環境（0264-48-2001）

**外ヶ浜町（sotogahama）:**
- 福祉課: 介護・子育て（0174-22-2941）
- 住民課: 保険・環境（0174-31-1222）

**豊能町（toyono）:**
- 保険課: 介護担当（072-739-3421）
- 税務課: 税務担当（072-739-3417）

**吉野町（yoshino）:**
- 長寿福祉課: 介護・子育て
- 町民税務課: 保険・税務
- 暮らし環境整備課: 建設・環境
- 電話番号: 主に代表（0746-32-3081）

#### 変更ファイル

- `/apps/web/data/artifacts/kanna/variables/core.json`
- `/apps/web/data/artifacts/kawachi/variables/core.json`
- `/apps/web/data/artifacts/kawasaki-miyagi/variables/core.json`
- `/apps/web/data/artifacts/kusatsu/variables/core.json`
- `/apps/web/data/artifacts/nanmoku/variables/core.json`
- `/apps/web/data/artifacts/nosegawa/variables/core.json`
- `/apps/web/data/artifacts/otaki/variables/core.json`
- `/apps/web/data/artifacts/sotogahama/variables/core.json`
- `/apps/web/data/artifacts/toyono/variables/core.json`
- `/apps/web/data/artifacts/yoshino/variables/core.json`

#### 注意事項

- 小規模な町村では同じ部署が複数の業務を兼務しているため、同じ部署名・電話番号が複数の変数に設定されています
- 直通電話番号が公開されていない自治体は代表番号を設定し、confidenceを0.7-0.8に設定しました
- 野迫川村のように、住民課内に「介護保険係」「福祉係」「税務係」などの係が明確に分かれている場合は、係名まで含めて記録しました
