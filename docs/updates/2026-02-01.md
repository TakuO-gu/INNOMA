# 2026-02-01 更新履歴

## Wikipedia風の変数ソース参照表示機能

### 概要
ページ内で使用している変数（`{{variable_name}}`）のソースURLをWikipedia風に参照表示する機能を実装。

### 変更内容

#### 1. 変数置換機能の拡張 (`lib/template/replace.ts`)
- `replaceVariablesWithSources()` 関数を追加
- 変数置換時に、使用した変数のソース情報（sourceUrl, confidence, source）を収集
- `VariableSourceInfo` 型と `ReplaceResultWithSources` 型を追加

#### 2. Artifact読み込み時のソース情報生成 (`lib/artifact/loader.ts`)
- `loadArtifactInternal()` で変数置換時にソース情報を収集
- `buildSourcesFromVariables()` 関数でソース情報をSource配列に変換
- 同じURLからの変数はグループ化
- ArtifactLoadResultに `sources: Source[]` を追加

#### 3. ページコンポーネントの更新 (`app/[municipality]/[[...path]]/page.tsx`)
- loadArtifactの結果から直接sourcesを取得
- BlockRendererにsourcesを渡す

#### 4. Sourcesブロックの追加
以下の全てのJSONファイルにSourcesブロックを追加:
- `_templates/` 配下の122ファイル
- `sample/` 配下のファイル
- `takaoka/` 配下のファイル
- 合計 366ファイル

### 動作
1. ページがロードされると、変数ストアから変数値と共にソースURLを取得
2. 使用された変数のソースURLをグループ化してSource配列を生成
3. ページ下部の「情報の出典」セクションにソース一覧を表示
4. 各ソースには参照番号[1], [2]...が付与され、アクセス日時も表示

### 関連ファイル
- `apps/web/lib/template/replace.ts` - 変数置換とソース情報収集
- `apps/web/lib/template/index.ts` - エクスポート追加
- `apps/web/lib/artifact/loader.ts` - ソース情報のArtifact統合
- `apps/web/app/[municipality]/[[...path]]/page.tsx` - ページコンポーネント
- `apps/web/components/blocks/components/SourcesBlocks.tsx` - UI表示（既存）

## 自動アップデートボット（Playwright対応）

### 概要
CLAUDE.mdのプロジェクトルールを理解し、サービスページの検証・最適化を自動で行うボットを実装。Playwrightによるブラウザ自動化でlocalhostのUIを確認しながら調整が可能。

### 機能

#### 1. 検証機能（validate）
- `schema_version`フィールドの存在確認
- Tableブロックの空value検出
- 手順リスト（3ステップ以上）のStepNavigation候補検出
- セクション順序チェック（COMPONENT_SELECTION_LOGIC.md準拠）
- 未定義変数の検出

#### 2. 最適化機能（optimize）
- 空のSectionを次のブロック（Table, StepNavigation等）と統合
- 条件分岐パターンのリストを検出

#### 3. UI検査機能（Playwright）
- `inspect`: 全ページを巡回し、未置換変数・空要素を検出
- `screenshot`: 全ページのスクリーンショットを取得
- `review`: 対話モードでページを確認しながら調整

### 使用方法
```bash
cd apps/web

# 基本的な検証
npm run bot validate --verbose

# ブラウザ表示してUIを確認（要: npm run dev）
npm run bot:inspect
npm run bot:review

# スクリーンショット取得
npm run bot:screenshot

# ヘルプ表示
npm run bot -- --help
```

### 追加されたnpmスクリプト
- `npm run bot` - 基本実行
- `npm run bot:inspect` - UI検査（headed）
- `npm run bot:review` - 対話的レビュー（headed）
- `npm run bot:screenshot` - スクリーンショット取得

### 関連ファイル
- `apps/web/scripts/auto-update-bot.ts` - メインスクリプト
- `apps/web/package.json` - npmスクリプト追加

### 依存パッケージ追加
- `playwright` - ブラウザ自動化
- `@playwright/test` - Playwright型定義
