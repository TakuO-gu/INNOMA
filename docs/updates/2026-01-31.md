# 2026-01-31 更新履歴

## コンテンツ改善

- 防災情報メール (bosai-mail) に「QRコードで登録」セクションを追加
  - 高岡市の実際のWebサイトでQRコード登録の案内があることを反映
  - テンプレート変数 `{{bosai_mail_qr_url}}` を使用
  - 対象ファイル:
    - `apps/web/data/artifacts/takaoka/services/disaster/bosai-mail.json`
    - `apps/web/data/artifacts/_templates/services/disaster/bosai-mail.json`
    - `apps/web/data/artifacts/sample/services/disaster/bosai-mail.json`

## 新機能追加

- UIレビューツール (`/dev/review`) を追加
  - Split View: 左側にレビューパネル、右側にページプレビュー
  - 要素選択: プレビュー上でブロック要素をクリックして選択
  - レビューフォーム: 要素名・改善指示・適用範囲（全体/個別）を記録
  - 自動保存: localStorage に経過を自動保存
  - AI向け出力: Markdown形式でレビュー内容を出力・コピー

## 変更ファイル

- `apps/web/app/dev/review/page.tsx` - メインページ（Server Component）
- `apps/web/app/dev/review/ReviewTool.tsx` - クライアントコンポーネント
- `apps/web/app/dev/review/types.ts` - 型定義
- `apps/web/app/dev/review/preview/[[...path]]/page.tsx` - プレビュー用ページ
- `apps/web/app/dev/review/preview/[[...path]]/InspectorScript.tsx` - インスペクター機能
- `apps/web/components/blocks/BlockRenderer.tsx` - data属性（data-block-type, data-block-id）を追加

## ハザードマップ機能強化

### 概要
ハザードマップページに地区選択＋PDF表示機能を追加。従来の外部リンクボタンに代わり、地区を選択するとその地区のハザードマップPDFを直接表示・ダウンロードできるように。

### 新規追加ファイル
- `apps/web/components/blocks/components/HazardMapViewerBlock.tsx` - ハザードマップビューアコンポーネント
- `apps/web/data/artifacts/takaoka/hazard-maps.json` - 高岡市のハザードマップデータ（13地区分のPDF URL）

### 変更ファイル
- `apps/web/components/blocks/components/index.ts` - HazardMapViewerBlockをエクスポート
- `apps/web/components/blocks/BlockRenderer.tsx` - HazardMapViewerを登録
- `apps/web/app/api/districts/[municipalityId]/[variableName]/route.ts` - hazard-maps APIエンドポイント追加
- `apps/web/data/artifacts/takaoka/services/disaster/hazard-map.json` - HazardMapViewerブロックを使用するように更新

### 機能詳細
- **HazardMapViewerBlock**: 地区選択ドロップダウン、PDFプレビュー（iframe）、ダウンロードボタン、防災学習資料リスト
- **hazard-maps.json**: 水害・土砂・地震・津波のカテゴリ別にPDF URLを管理
- **水害ハザードマップ**: 13地区（西広谷地区を除く）のPDF、情報学習資料9点を含む

## Breadcrumbsリンク修正

### 概要
`/topics` ページが存在しないため、Breadcrumbsのリンクが動作しなかった問題を修正。

### 対応内容
- topicsディレクトリ内の全ファイル（44ファイル）から「くらしの情報」リンク（`/topics`）を削除
- Breadcrumbs構造を「ホーム → 各トピック」の2階層に変更

### 変更ファイル
- `apps/web/data/artifacts/takaoka/topics/*.json` (14ファイル)
- `apps/web/data/artifacts/_templates/topics/*.json` (15ファイル)
- `apps/web/data/artifacts/sample/topics/*.json` (15ファイル)

## バグ修正

### ホームページ（/）へのBreadcrumbsリンクが表示されない問題を修正

- **問題**: `isPageCompleted` 関数がホームページ（`/`）を完成済みページとして認識せず、Breadcrumbsの「ホーム」リンクが非表示になっていた
- **対応**: `isPageCompleted` でホームページ（`/` または空文字列）を常に `true` として返すように修正
- **変更ファイル**: `apps/web/components/blocks/MunicipalityContext.tsx`

### データファイルを data/ サブディレクトリに移動

- **問題**: `/dev/review/preview/takaoka/hazard-maps` のようなパスでデータファイルが誤ってページとして表示されてしまう問題
- **原因**: `[[...path]]` キャッチオールルートが `takaoka/hazard-maps.json` をアーティファクトとして読み込もうとしていた
- **対応**: データファイル（`districts.json`, `shelters.json`, `hazard-maps.json`）を `takaoka/data/` サブディレクトリに移動
- **変更ファイル**:
  - `apps/web/data/artifacts/takaoka/data/districts.json` (移動)
  - `apps/web/data/artifacts/takaoka/data/shelters.json` (移動)
  - `apps/web/data/artifacts/takaoka/data/hazard-maps.json` (移動)
  - `apps/web/app/api/districts/[municipalityId]/[variableName]/route.ts` - パス更新
  - `apps/web/lib/template/district-variables.ts` - パス更新

## services内のBreadcrumbsリンク修正

### 概要
servicesディレクトリ内の全ファイルから「くらしの情報」リンク（`/topics`）を削除。

### 対応内容
- Breadcrumbs構造を「ホーム → 各トピック → サービス」の3階層から「ホーム → 各トピック → サービス」の3階層に変更（中間の `/topics` リンクを削除）
- 全299ファイルを一括修正
- 対象ディレクトリ:
  - `apps/web/data/artifacts/_templates/services/**/*.json` (100ファイル)
  - `apps/web/data/artifacts/sample/services/**/*.json` (100ファイル)
  - `apps/web/data/artifacts/takaoka/services/**/*.json` (99ファイル)

## UIレビュー対応

### 1. リストと段落間のスペース調整

- **問題**: Section内のリストとテキストの間の改行が狭すぎる
- **対応**: RichTextRendererのリスト要素に `my-4` クラスを追加してマージンを確保
- **変更ファイル**: `apps/web/components/blocks/RichTextRenderer.tsx`

### 2. Attachmentsブロックの実装

- **問題**: 「未対応ブロック: Attachments」と表示される
- **対応**: AttachmentsBlockコンポーネントを新規作成
  - PDFなどの添付ファイルをダウンロードリンクとして表示
  - ファイルタイプ（PDF、Word、Excel等）に応じたアイコン表示
  - 未設定の変数（`{{...}}`）を含むアイテムは非表示
- **新規ファイル**: `apps/web/components/blocks/components/AttachmentsBlock.tsx`
- **変更ファイル**:
  - `apps/web/components/blocks/components/index.ts` - エクスポート追加
  - `apps/web/components/blocks/BlockRenderer.tsx` - レジストリ登録

### 3. オンラインサービスへのリンク追加

- **問題**: オンライン申請の説明があっても、実際の申請サイトへのリンクがない
- **対応**: 国が提供するオンラインサービスへのTaskButtonを追加
- **追加したリンク**:
  - マイナンバーカード: `https://www.kojinbango-card.go.jp/` (mynumber.json)
  - マイナポータル（転出届）: `https://myna.go.jp/` (tenshutsu.json)
  - マイナポータル（国民健康保険）: `https://myna.go.jp/` (kokuho.json)
- **変更ファイル**:
  - `apps/web/data/artifacts/_templates/services/registration/mynumber.json`
  - `apps/web/data/artifacts/_templates/services/registration/tenshutsu.json`
  - `apps/web/data/artifacts/_templates/services/health/kokuho.json`
  - 同様の変更をtakaoka/sampleにも適用

## コンポーネント選択ロジック設計

### 概要
サービスページのコンテンツを適切なDADSコンポーネントで表示するための選択ロジックを設計・実装。

### 新規ドキュメント
- `docs/DADS_COMPONENTS.md` - デジタル庁デザインシステム全コンポーネントガイド
  - 34個のReactコンポーネントの用途・使用方法をまとめ
  - INNOMAサービスページでの推奨使用パターン表
- `docs/COMPONENT_SELECTION_LOGIC.md` - コンポーネント選択ロジック
  - 情報タイプ別のブロックタイプマッピング
  - content_type別デフォルト構成
  - セクション自動生成ルール
  - LLMプロンプト用決定木

### 新規実装
- `apps/web/lib/llm/prompts/content-structurer.ts` - コンテンツ構造化プロンプト
  - `analyzeAndStructure()`: コンテンツを分析してブロックに変換
  - `getRecommendedBlockType()`: 情報タイプから推奨ブロックタイプを取得
  - `COMPONENT_SELECTION_RULES`: LLM向けコンポーネント選択ルール
- `apps/web/lib/llm/index.ts` - 新モジュールのエクスポート追加

### 設計方針
- LLMが直接生成: 情報取得時に適切なコンポーネントを選んでJSON出力
- 既存ブロックタイプを維持: INNOMAスキーマを活かしつつDADSにマッピング
- 重視項目: ステップ・手順の可視化、必要書類の明確化
- リッチコンポーネント許容: アコーディオン、テーブル等を積極活用

### テスト用API
- `POST /api/dev/structure` - コンテンツ構造化API
  - URLまたは生コンテンツからブロック構造を自動生成
  - 入力: `{ url?, content?, serviceName, municipalityName }`
  - 出力: `{ blocks, summary, blockCount, processingTimeMs }`
- 動作確認済み: 住民票の写しの交付で8ブロック生成（StepNavigation含む）

## callout廃止・DADS統一

### 概要
`callout`はDADSに存在しないカスタムタイプだったため、DADSコンポーネントに統一。

### 変換ルール（COMPONENT_SELECTION_RULESに基づく）
- **50文字以上**: `NotificationBanner`ブロックとして独立抽出
- **50文字未満**: RichText内に残す（後方互換のため単純なdivで表示）

### 実行結果
- 処理ファイル数: 378
- 変換されたファイル: 62
- 50文字未満のcallout残存: 28ファイル（後方互換性のため維持）

### 変換ルール詳細
1. **severity: warning/danger** → NotificationBanner（文字数に関係なく）
2. **severity: info で50文字以上** → NotificationBanner
3. **severity: info で50文字未満** → RichText内のテキストに展開

### 実行結果（最終）
- 処理ファイル数: 378
- callout → NotificationBanner変換: 80件
- callout → RichText展開: 11件
- **残存callout: 0件**（完全廃止達成）

### 変更ファイル
- `apps/web/scripts/convert-callout-to-dads.ts` - 初回変換スクリプト
- `apps/web/scripts/convert-remaining-callouts.ts` - 残存callout変換スクリプト
- `apps/web/components/blocks/RichTextRenderer.tsx` - calloutを単純なdivで表示（後方互換）
- `apps/web/lib/llm/prompts/content-structurer.ts` - calloutをルールから削除
- 84個のサービスページJSON（_templates, sample, takaokaディレクトリ）

## ブロック構造最適化（COMPONENT_SELECTION_RULES準拠）

### 概要
既存のページデータをCOMPONENT_SELECTION_RULESに基づいて再構成。リストや定義形式のコンテンツを適切なコンポーネントに変換。

### 変換ルール
1. **空のSection（content空配列）** → 次のブロックと統合または削除
2. **3ステップ以上の番号付きリスト（手順系セクション）** → StepNavigation
3. **条件分岐パターン（「の場合」「本人/代理人」等）のリスト** → Table
4. **定義リスト形式（太字：説明）** → DescriptionList

### 実行結果
- 処理ファイル数: 375
- 変更ファイル数: 134

### 変換統計
| 変換タイプ | 件数 |
|-----------|------|
| conditional list → Table | 96 |
| definition list → DescriptionList | 69 |
| ordered list → StepNavigation | 15 |
| empty Section merged | 多数 |
| empty Section before NotificationBanner removed | 9 |

### 主な変換例
- `juminhyo.json`: 住民票の種類 → DescriptionList、請求者/必要書類 → Table
- `jidou-teate.json`: 支給額 → Table、申請に必要なもの → Table
- `building-permit.json`: 申請の流れ（8ステップ） → StepNavigation
- `privacy.json`: 請求方法 → StepNavigation、請求できる権利 → DescriptionList

### 変更ファイル
- `apps/web/scripts/optimize-blocks-with-rules.ts` - 最適化スクリプト
- 134個のサービスページJSON（_templates, sample, takaokaディレクトリ）
