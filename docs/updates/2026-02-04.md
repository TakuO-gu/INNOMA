# 2026-02-04 更新履歴

## 新機能追加

### コンテンツレビューシステム

自治体Webサイトのソース変更を検知し、関連ページを自動的に非公開にするシステムを追加。

#### 機能概要

1. **ソース変更検知**
   - 各変数のソースURL（sourceUrl）のコンテンツハッシュ（SHA-256）を保存
   - 定期的にソースURLを再取得してハッシュを比較
   - 変更が検出された場合、その変数を使用しているページを「レビュー待ち」状態にする

2. **ページ単位のレビュー管理**
   - `{municipality}/page-reviews.json` でページごとのレビュー状態を管理
   - 状態: `published` / `review_required` / `under_review`

3. **市民向けページの自動非公開**
   - レビュー待ちページにアクセスすると「更新中」メッセージを表示
   - 公式サイトへのリンクを案内

4. **管理画面**
   - `/admin/reviews` - レビュー待ちページ一覧
   - `/admin/reviews/[municipalityId]/[...pagePath]` - レビュー詳細・承認/却下

#### 実装ファイル

**新規作成**
- `docs/specs/CONTENT_REVIEW_SPEC.md` - 設計書
- `lib/review/` - レビューシステム
  - `types.ts` - 型定義
  - `storage.ts` - ページレビュー状態管理
  - `source-checker.ts` - ソース変更検知ロジック
  - `variable-page-map.ts` - 変数→ページマッピング
  - `index.ts` - エクスポート
- `app/api/cron/check-source-changes/route.ts` - Cron API
- `app/api/admin/reviews/` - レビュー管理API
- `app/admin/reviews/` - レビュー管理画面
- `components/blocks/ReviewPendingMessage.tsx` - 更新中メッセージ

**変更**
- `lib/template/types.ts` - `VariableValue`にソース変更検知用フィールド追加
- `lib/notification/types.ts` - 通知タイプ追加（`source_changed`, `review_approved`, `review_dismissed`）
- `app/[municipality]/[[...path]]/page.tsx` - レビュー待ちチェック追加
- `app/admin/layout.tsx` - ナビゲーションにレビュー追加

#### データ構造の拡張

**VariableValue（変数値）**
```typescript
interface VariableValue {
  // 既存フィールド...

  // 新規追加: ソース変更検知用
  sourceContentHash?: string;      // ソースURLのコンテンツハッシュ
  lastSourceCheckAt?: string;      // 最後にソースを確認した日時
  sourceChanged?: boolean;         // ソースが変更されたか
  sourceChangedAt?: string;        // 変更が検出された日時
}
```

**MunicipalitySettings（自治体設定）**
```typescript
interface MunicipalitySettings {
  // 既存フィールド...

  // 新規追加
  sourceCheckInterval?: "disabled" | "daily" | "weekly" | "monthly";
}
```

#### Cron設定

```json
{
  "crons": [{
    "path": "/api/cron/check-source-changes",
    "schedule": "0 4 * * *"
  }]
}
```

---

## 設定変更

なし

---

## ドキュメント更新

- `docs/specs/CONTENT_REVIEW_SPEC.md` - コンテンツレビューシステム設計書を新規作成
