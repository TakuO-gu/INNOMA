# 2026-01-20 更新履歴

## ドキュメント整備

- `CLAUDE.md` をルートに配置（Claude Code設定専用）
- `docs/PROJECT.md` を作成（プロジェクト概要を分離）
- `docs/updates/` ディレクトリを作成（更新履歴用）

## アーカイブ（ドキュメント）

以下を `archive/docs/` に移動:
- `/README.md` → `archive/docs/ROOT_README.md`
- `/apps/web/README.md` → `archive/docs/apps_web_README.md`
- `/packages/schema/README.md` → `archive/docs/packages_schema_README.md`
- `/.claude/CLAUDE_*.md` → `archive/docs/`（セッションログ4件）

## アーカイブ（不要データ・ファイル）

以下を `archive/` に移動:
- `/data/` → `archive/data_root/`（クローラー出力、パイプライン用データ）
- `/.venv/` → `archive/.venv/`（Python仮想環境）
- `/CNAME` → `archive/CNAME`（GitHub Pages用）

以下を `archive/data/web_artifacts/` に移動:
- `apps/web/data/artifacts/aogashima*`（テスト用）
- `apps/web/data/artifacts/mikasa`（テスト用）
- `apps/web/data/artifacts/takaoka`（テスト用）
- `apps/web/data/artifacts/test-city`（テスト用）
- `apps/web/data/artifacts/utashinai`（テスト用）
- `apps/web/data/artifacts/sample-*`（テスト用）

## ディレクトリ構成変更

- `apps/web/data/artifacts/_base` → `_templates` にリネーム
- `apps/web/data/artifacts/_drafts` を新規作成
- `.gitignore` に `archive/` を追加（Gitで追跡しない）

## 現在のartifacts構成

```
apps/web/data/artifacts/
├── _templates/   # ベーステンプレート
├── _drafts/      # 下書き保存（新規作成）
└── sample/       # サンプル自治体
```

---

## 新機能追加（Phase 1実装）

### テンプレートシステム (lib/template/)

- `types.ts`: テンプレートシステムの型定義を追加
  - `VariableStore`: 変数ストアの構造
  - `MunicipalityMeta`: 自治体メタデータ
  - `MunicipalitySummary`: 自治体一覧表示用データ
  - `CreateMunicipalityInput`: 自治体追加入力
  - `PREFECTURES`: 都道府県リスト

- `clone.ts`: テンプレート複製機能を実装
  - `cloneTemplate()`: sampleテンプレートを複製して新自治体を作成
  - `extractTemplateVariables()`: テンプレート内の変数を抽出
  - `getMunicipalityPageCount()`: ページ数取得
  - `deleteMunicipality()`: 自治体削除

- `replace.ts`: 変数置換機能を実装
  - `replaceVariables()`: `{{variable_name}}`形式の変数を置換
  - `extractVariables()`: コンテンツから変数を抽出
  - `validators`: 電話番号、メール、URL、金額等の検証関数

- `storage.ts`: 自治体データ操作を実装
  - `getMunicipalities()`: 自治体一覧取得
  - `getMunicipality()`: 自治体詳細取得
  - `getMunicipalityMeta()`: メタデータ取得
  - `getVariableStore()`: 変数ストア取得
  - `updateVariableStore()`: 変数ストア更新

### 管理画面 (app/admin/)

- `layout.tsx`: 管理画面レイアウトを更新
  - ナビゲーション追加（ダッシュボード、自治体一覧、新規追加、下書き）
  - サイトプレビューリンク追加

- `page.tsx`: ダッシュボードを刷新
  - 統計表示（自治体数、ページ数、下書き数）
  - 自治体一覧（最新10件）
  - ステータスバッジ表示

- `municipalities/page.tsx`: 自治体一覧ページ
  - テーブル形式で自治体を表示
  - ステータス、ページ数、変数設定率を表示
  - プログレスバー付き

- `municipalities/new/page.tsx`: 新規自治体追加フォーム
  - 自治体ID、名前、都道府県の入力
  - 公式サイトURL入力
  - LLM情報取得オプション

- `municipalities/[id]/page.tsx`: 自治体詳細ページ
  - 基本情報と統計表示
  - 変数一覧テーブル
  - 削除機能

- `drafts/page.tsx`: 下書き一覧ページ（プレースホルダー）

### API (app/api/admin/)

- `municipalities/route.ts`: 自治体一覧・追加API
  - GET: 自治体一覧取得
  - POST: 新規自治体追加（テンプレート複製）

- `municipalities/[id]/route.ts`: 自治体詳細・更新・削除API
  - GET: 自治体詳細取得
  - PUT: 自治体更新
  - DELETE: 自治体削除

## バグ修正

- 古い静的サンプルページ (`app/municipalities/sample/`) を削除
  - 動的ルート (`[municipality]/[[...path]]/page.tsx`) で代替済み

## 設定変更

- `eslint.config.mjs`: ESLint設定を追加
  - Next.js推奨設定を適用
  - `react/display-name`をoff（既存コード対応）
  - 未使用変数の `_` プレフィックス許可

## リファクタリング

- 既存コードのLintエラー修正
  - `lib/storage/s3-adapter.ts`: 未使用引数に `_` プレフィックス
  - `components/blocks/BlockRenderer.tsx`: 未使用interfaceに `_` プレフィックス
  - `app/dev/dads/BuildingBlocksMainArea.tsx`: 未使用変数に `_` プレフィックス

---

## Phase 2 実装: LLM情報取得システム

### LLM Fetcher基盤 (lib/llm/)

- `types.ts`: LLM Fetcherシステムの型定義
  - `LLMFetchConfig`: 取得設定
  - `SearchResult`: 検索結果
  - `ExtractedVariable`: 抽出された変数
  - `FetchJob`: 取得ジョブ状態
  - `Draft`: 下書きデータ

- `google-search.ts`: Google Custom Search APIクライアント
  - `googleSearch()`: 検索実行
  - `searchMunicipalitySite()`: 自治体公式サイト内検索
  - `isOfficialDomain()`: 公式ドメイン判定
  - `calculateUrlCredibility()`: URL信頼度スコア計算

- `gemini.ts`: Google Gemini APIクライアント
  - `generateContent()`: コンテンツ生成
  - `generateJSON()`: JSON形式での構造化出力

- `prompts/query-generator.ts`: 検索クエリ生成
  - `generateSearchQuery()`: 最適な検索クエリを生成
  - `generateServiceSearchQueries()`: サービス別クエリ一括生成

- `prompts/extractor.ts`: 情報抽出
  - `extractVariables()`: ページコンテンツから変数抽出
  - `extractFromSnippets()`: 検索スニペットから抽出
  - `extractContactInfo()`: 連絡先情報特化抽出
  - `extractFeeInfo()`: 料金情報特化抽出

- `validators.ts`: 値検証
  - `validatePhone()`: 電話番号検証
  - `validateEmail()`: メールアドレス検証
  - `validateUrl()`: URL検証
  - `validateFee()`: 金額検証
  - `validateDate()`: 日付検証
  - その他各種バリデーター

- `page-fetcher.ts`: ページ取得
  - `fetchPage()`: ページ取得とテキスト抽出
  - `fetchPages()`: 複数ページ取得（レート制限対応）

- `variable-priority.ts`: 変数優先度定義
  - `highPriorityVariables`: 高優先度変数リスト
  - `serviceDefinitions`: サービス別変数グルーピング

- `fetcher.ts`: メイン取得ロジック
  - `fetchServiceVariables()`: サービス別変数取得
  - `fetchAllVariables()`: 全変数取得
  - `fetchSpecificVariables()`: 指定変数取得

### 下書きシステム (lib/drafts/)

- `types.ts`: 下書きシステムの型定義
  - `Draft`: 下書きデータ構造
  - `DraftSummary`: 一覧表示用
  - `DraftComparison`: 差分比較結果

- `storage.ts`: 下書き保存・読み込み
  - `getAllDrafts()`: 下書き一覧取得
  - `getDraft()`: 下書き詳細取得
  - `createDraft()`: 下書き作成
  - `updateDraftStatus()`: ステータス更新
  - `deleteDraft()`: 下書き削除

- `diff.ts`: 差分検出
  - `compareDraftWithStore()`: 下書きと既存変数の比較
  - `applyDraftToStore()`: 下書きを変数ストアに反映

### 管理画面 - 下書き関連

- `app/admin/drafts/page.tsx`: 下書き一覧ページ（実装完了）
  - 統計表示（総数、レビュー待ち、承認済み等）
  - 下書きテーブル（ステータス、取得状況、更新日時）

- `app/admin/drafts/[municipalityId]/[service]/page.tsx`: 下書き詳細ページ
  - 取得済み変数一覧（信頼度、ソースURL表示）
  - 未取得変数リスト
  - エラー表示

- `app/admin/drafts/[municipalityId]/[service]/DraftActions.tsx`: アクションボタン
  - 承認して反映
  - 却下
  - 削除

- `app/admin/municipalities/[id]/FetchButton.tsx`: 情報取得ボタン
  - 自治体詳細ページから直接LLM取得を実行

### API - 下書き関連

- `api/admin/drafts/route.ts`: 下書き一覧API
  - GET: 下書き一覧と統計取得

- `api/admin/drafts/[municipalityId]/[service]/route.ts`: 下書き詳細API
  - GET: 下書き詳細取得
  - PUT: 承認/却下
  - DELETE: 削除

- `api/admin/municipalities/[id]/fetch/route.ts`: LLM取得API
  - POST: 指定自治体の情報をLLMで取得

---

## Phase 3 実装: 運用機能

### 手動変数編集 (Phase 3.2)

- `app/admin/municipalities/[id]/VariableTable.tsx`: インライン編集機能を追加
  - 編集ボタンをクリックで入力フィールドに切り替え
  - 保存・キャンセル操作
  - API経由で変数を更新
  - 更新後に画面をリフレッシュ

- `api/admin/municipalities/[id]/variables/route.ts`: 変数更新API（新規作成）
  - PUT: 変数値を更新
  - 形式検証（電話番号、メール、URL等）
  - ISR再検証トリガー
  - エラーハンドリング

### ISR再検証トリガー (Phase 3.1)

- `api/admin/drafts/[municipalityId]/[service]/route.ts`: 承認時のISR再検証を追加
  - `revalidatePath()` で関連ページのキャッシュを無効化
  - 自治体ページ（`/[municipalityId]`）
  - サブページ（`/[municipalityId]/[...path]`）
  - 管理画面（`/admin/municipalities/[id]`）

### 定期更新 (Phase 3.3)

- `api/cron/update-municipalities/route.ts`: Vercel Cron Job（新規作成）
  - 毎週月曜 3:00 AM に実行
  - 更新閾値（7日以上未取得）の自治体を対象
  - 1回あたり最大5自治体を処理
  - サービス間のレート制限（2秒）
  - CRON_SECRET による認証
  - 既存の下書きがある場合はスキップ

- `vercel.json`: Cron設定を追加
  - スケジュール: `0 3 * * 1`（毎週月曜 3:00 AM UTC）

### IMPLEMENTATION_PLAN.md 更新

- Phase 3.1（承認ワークフロー）: 完了
  - [x] 承認/却下API
  - [x] 承認時のArtifact更新
  - [x] ISR再検証トリガー

- Phase 3.2（手動編集）: 完了
  - [x] 変数値の直接編集UI
  - [x] 編集履歴の記録

- Phase 3.3（定期更新）: 完了
  - [x] Vercel Cron設定
  - [x] 更新対象の自動判定
  - [x] 差分通知

---

## Phase 3 追加実装: 編集履歴・通知システム

### 編集履歴システム (lib/history/)

- `types.ts`: 編集履歴の型定義
  - `HistoryEntry`: 履歴エントリ（変更タイプ、ソース、変更内容等）
  - `VariableChange`: 変数変更の詳細
  - `HistorySummary`: 一覧表示用

- `storage.ts`: 履歴ストレージ操作
  - `addHistoryEntry()`: 履歴追加
  - `recordVariableUpdate()`: 変数更新履歴
  - `recordBulkVariableUpdate()`: 一括更新履歴
  - `recordDraftApproval()`: 下書き承認履歴
  - `recordDraftRejection()`: 下書き却下履歴
  - `getHistoryList()`: 履歴一覧取得
  - `getHistoryStats()`: 履歴統計

### 通知システム (lib/notification/)

- `types.ts`: 通知の型定義
  - `Notification`: 通知エントリ
  - `NotificationType`: 通知種類（下書き作成、承認、却下、更新等）
  - `NotificationSeverity`: 重要度（info, success, warning, error）

- `storage.ts`: 通知ストレージ操作
  - `addNotification()`: 通知追加
  - `notifyDraftCreated()`: 下書き作成通知
  - `notifyDraftApproved()`: 下書き承認通知
  - `notifyDraftRejected()`: 下書き却下通知
  - `notifyVariableUpdated()`: 変数更新通知
  - `notifyCronCompleted()`: 定期更新完了通知
  - `notifyCronFailed()`: 定期更新失敗通知
  - `getNotifications()`: 通知一覧取得
  - `markAsRead()`: 既読にする
  - `markAllAsRead()`: すべて既読にする

### API

- `api/admin/municipalities/[id]/history/route.ts`: 履歴API
  - GET: 履歴一覧・詳細・統計取得

- `api/admin/notifications/route.ts`: 通知API
  - GET: 通知一覧・詳細・統計取得
  - PUT: 既読にする
  - DELETE: 通知削除

### 管理画面UI

- `app/admin/municipalities/[id]/HistoryTable.tsx`: 履歴テーブル
  - 変更履歴の一覧表示
  - 変更種類、ソース、変更数、実行者、日時

- `app/admin/components/NotificationBell.tsx`: 通知ベル
  - ヘッダーに通知アイコン表示
  - 未読バッジ表示
  - ドロップダウンで最新通知表示

- `app/admin/notifications/page.tsx`: 通知一覧ページ
  - 全通知の一覧表示
  - フィルター（すべて/未読のみ）
  - 既読/削除操作

### 既存APIの更新

- `api/admin/municipalities/[id]/variables/route.ts`: 履歴記録追加
- `api/admin/drafts/[municipalityId]/[service]/route.ts`: 履歴・通知追加
- `api/cron/update-municipalities/route.ts`: 通知追加

---

## バグ修正: CSS参照

### テンプレートコンポーネントを`@/components/dads`参照に統一

`components/blocks/dads`のコンポーネントが独自のCSSクラス（`dads-link`等）を使用していたため、
TailwindベースのDADSコンポーネント（`@/components/dads`）を参照するように修正。

**修正ファイル:**

- `components/blocks/dads/DadsLink.tsx`: `@/components/dads`の`Link`コンポーネントを使用
- `components/blocks/dads/DadsBreadcrumbs.tsx`: `@/components/dads`の`Breadcrumbs`系コンポーネントを使用
- `components/blocks/dads/DadsResourceList.tsx`: `@/components/dads`の`ResourceList`系コンポーネントを使用
- `components/blocks/richtext/RichTextRenderer.tsx`: `@/components/dads`の`Link`コンポーネントを使用

**変更内容:**
- CSSクラス（`dads-link`等）から、TailwindスタイルのReactコンポーネントに移行
- `NextLink`との統合により、Next.jsのクライアントサイドナビゲーションをサポート
- 外部リンクと内部リンクの適切なハンドリング（`target="_blank"`、`rel="noopener noreferrer"`）

---

## リファクタリング: BlockRenderer統合

### `components/blocks`ディレクトリの整理

`BlockRenderer.tsx`に全機能を統合し、不要なファイルをアーカイブ。

**変更内容:**

1. **BlockRenderer.tsxへの統合**
   - `MunicipalityContext`（Reactコンテキスト、`useMunicipality`フック、`prefixInternalLink`関数）を統合
   - `RichTextRenderer`機能を統合
   - 全てのブロックコンポーネントで`@/components/dads`を直接参照

2. **アーカイブされたファイル** (`archive/components_blocks/`へ移動)
   - `dads/` ディレクトリ全体（DadsLink, DadsBreadcrumbs, DadsResourceList等）
   - `richtext/` ディレクトリ（RichTextRenderer.tsx）
   - `MunicipalityContext.tsx`

3. **現在の`components/blocks`構成**
   ```
   components/blocks/
   └── BlockRenderer.tsx   # 唯一のファイル（全機能統合済み）
   ```

**修正されたコード:**
- `NotificationBanner`のtype属性を正しい型（`info1`, `info2`, `warning`, `error`, `success`）に修正

**利点:**
- `@/components/dads`のTailwindベースコンポーネントのみを参照
- コード重複の削減
- シンプルなディレクトリ構造

---

## アーカイブ: schemaパッケージ

`packages/schema/`を`archive/packages/schema/`に移動。

**理由:**
- 現在のテンプレートベースの管理画面では未使用
- Artifact用のスキーマは`lib/artifact/`で定義
- モノレポ構成の簡素化

**対応:**
- `innoma-artifact-schema.v2.ts`を`lib/artifact/`にコピー
- `lib/artifact/schema.ts`のimportを`./innoma-artifact-schema.v2`に変更
- `package.json`から`@innoma/schema`依存を削除

---

## 新機能: 市民向けページ共通ヘッダー

全ての自治体ページ（`/[municipality]/**`）に統一されたヘッダーを追加。

### 追加ファイル

- `components/layout/MunicipalityHeader.tsx`: 自治体ページ専用ヘッダーコンポーネント
  - INNOMAロゴ（クリックでトップページへ）
  - 自治体名（クリックで自治体トップへ）
  - 検索バー（自治体内検索）
  - ナビゲーション（トップ、他の自治体）
  - レスポンシブ対応（モバイルはハンバーガーメニュー）

- `app/[municipality]/layout.tsx`: 自治体ページ共通レイアウト
  - `getMunicipalityMeta()`で自治体名を取得
  - `MunicipalityHeader`コンポーネントを表示

### ドキュメント

- `docs/UI_SPEC.md`: 市民向けUI仕様書を新規作成
  - ヘッダーの要素、レイアウト、レスポンシブ対応
  - 検索機能、ナビゲーション
  - スタイリング仕様

- `docs/PROJECT.md`: 実装状況に追記
  - 共通ヘッダー、編集履歴、通知システムを実装済みに追加

---

## 新機能: 自治体内検索

ヘッダーの検索バーから自治体内のコンテンツを検索可能に。

### 追加ファイル

- `lib/search/index.ts`: 検索ライブラリ
  - `searchMunicipality()`: 自治体内検索を実行
  - `getSearchSuggestions()`: 検索候補取得（将来用）
  - Artifactを直接走査して検索
  - 関連度スコア計算（タイトル一致、本文マッチ等）

- `app/[municipality]/search/page.tsx`: 検索結果ページ
  - 検索クエリを受け取り結果を表示
  - コンテンツタイプバッジ（ページ、手続き、緊急情報等）
  - 検索候補キーワード表示

- `app/[municipality]/search/MunicipalitySearchBox.tsx`: 検索ボックス
  - 検索クエリ入力
  - Enterまたはボタンで検索実行

### 更新ファイル

- `docs/UI_SPEC.md`: 検索機能の詳細仕様を追記

---

## コンポーネント整備: デジタル庁デザインシステム準拠

### StepNavigation コンポーネントの公式CSS移植

デジタル庁デザインシステムHTML版の `step-navigation.css` をReactコンポーネントとして移植。

**追加ファイル:**
- `components/dads/StepNavigation/step-navigation.css`: 公式CSSを移植
- `components/dads/StepNavigation/StepNavigation.tsx`: Reactコンポーネント
- `components/dads/StepNavigation/index.ts`: エクスポート

**コンポーネント構成:**
- `StepNavigation` - ルートコンポーネント (orientation, size 対応)
- `StepNavigationStep` - 各ステップ (state管理: default/reached/completed/error/skipped/editing)
- `StepNavigationHeader` - ヘッダー部分 (div/a/button)
- `StepNavigationNumber` - 番号表示
- `StepNavigationTitle` - タイトル
- `StepNavigationDescription` - 説明文
- `StepNavigationStateIcon` - 状態アイコン
- `StepNavigationStateLabel` - 状態ラベル

### blocks コンポーネントの dads 整合性修正

#### StepNavigationBlock
- 独自実装から `dads/StepNavigation` を使用するように変更
- 状態管理機能を追加:
  - `currentStep` props で現在のステップを指定可能
  - ステップごとに `state` を個別に指定可能
  - `currentStep` 以下は自動的に `completed`/`reached` 状態になる

#### AccordionBlock
- 独自の `<details>` 実装から `dads/Accordion` コンポーネントを使用するように変更
- `Accordion`, `AccordionSummary`, `AccordionContent` を使用

### 型定義の拡張
- `components/blocks/types.ts` に `StepItemState` 型を追加
- `StepItem` インターフェースに `state` プロパティを追加

### テストの更新
- `tests/dads-sot.test.tsx` を新しい dads コンポーネント構造に対応
- 全4テスト（Breadcrumbs, ResourceList, NotificationBanner, StepNavigation）が通過

### 確認済み
- ビルド成功
- Lint 通過 (既存の img 警告のみ)
- テスト通過 (4/4)

---

## CSS戦略の統一: Tailwind + 公式Reactコンポーネント

### 方針変更
DADS HTML版のCSS（BEMクラス）を廃止し、公式Reactコンポーネントと同じTailwindユーティリティクラスベースに統一。

### 調査結果
- `@digital-go-jp/tailwind-theme-plugin` はデザイントークンのみ提供（コンポーネントなし）
- 公式Reactコンポーネント (34個): GitHub `design-system-example-components-react` で提供
- 公式React版に存在しないコンポーネント: **StepNavigation**, **ResourceList**

### 変更内容

#### StepNavigationをTailwindで再実装
`components/dads/StepNavigation/StepNavigation.tsx`:
- HTML版CSS (`step-navigation.css`) を削除
- Tailwindユーティリティクラスで完全に再実装
- CSS変数はインラインstyleで管理
- 全状態 (default, reached, completed, error, skipped, editing) 対応
- 全オリエンテーション (horizontal, vertical) 対応
- 全サイズ (normal, small) 対応

#### globals.cssのDADS CSSを削除
`app/globals.css`:
- 2094行 → 296行 (約1800行削減)
- 削除したCSS:
  - `.dads-heading` (heading.css)
  - `.dads-link` (link.css)
  - `.dads-breadcrumb` (breadcrumb.css)
  - `.dads-divider` (divider.css)
  - `.dads-list` (list.css)
  - `.dads-accordion` (accordion.css)
  - `.dads-notification-banner` (notification-banner.css)
  - `.dads-emergency-banner` (emergency-banner.css)
  - `.dads-step-navigation` (step-navigation.css)
  - `.dads-table` (table.css)
- 残したスタイル: アプリ固有のコンポーネント (`.dads-page`, `.dads-richtext`, `.dads-contact` 等)

### 現在のCSS戦略
1. **デザイントークン**: `@digital-go-jp/design-tokens/dist/tokens.css` をimport
2. **Tailwindテーマ**: `@digital-go-jp/tailwind-theme-plugin` でトークンをTailwindに統合
3. **コンポーネント**: `components/dads/` でTailwindユーティリティクラスを使用

### 確認済み
- ビルド成功
- テスト通過 (4/4)

---

## 新機能: LLM情報取得時のPDF OCR機能

### Google Vision API統合 (lib/pdf/)

LLM情報取得時にPDFや画像からテキストを抽出する機能を追加。
検索結果にPDFが含まれている場合、Vision APIでOCRを実行してテキストを抽出し、
LLMが情報を抽出できるようにする。

**追加ファイル:**

- `lib/pdf/vision-ocr.ts`: Google Vision API OCR機能
  - `extractTextFromPdfUrl()`: URLから画像を取得してOCR
  - `extractTextFromBase64Image()`: Base64画像からOCR
  - `extractTextFromImages()`: 複数画像の一括OCR
  - `extractTextFromGcsPdf()`: Cloud Storage PDF用（将来実装）

- `lib/pdf/cache.ts`: OCR結果キャッシュ管理
  - `getCachedOcr()`: キャッシュ取得
  - `setCachedOcr()`: キャッシュ保存
  - `deleteCachedOcr()`: キャッシュ削除
  - `hasCachedOcr()`: キャッシュ存在確認
  - SHA256ハッシュによるURLキー生成
  - ファイルシステム上に`data/pdf-cache/`に保存

- `lib/pdf/index.ts`: モジュールエクスポート

### LLM Fetcherへの統合 (lib/llm/)

**更新ファイル:**

- `lib/llm/page-fetcher.ts`:
  - PDF/画像URLを検出してOCRを実行
  - `isPdfUrl()`, `isImageUrl()`: URL種別判定
  - `fetchPdfContent()`: PDF/画像コンテンツのOCR取得
  - キャッシュがあればキャッシュを使用、なければOCR実行してキャッシュ保存
  - `isUsefulUrl()`からPDF/画像を除外リストから削除（OCR可能なため）

- `lib/llm/types.ts`:
  - `PageContent`に`contentType`と`error`フィールドを追加

### 管理画面API

**追加ファイル:**

- `app/api/admin/pdf/ocr/route.ts`: PDF OCR管理API
  - POST: OCRを実行してキャッシュに保存（force オプションで再実行）
  - GET: キャッシュの状態を確認

### 環境変数の整理

**更新ファイル:**

- `.env.example`: Google API キーの設定例を追加
- `.env.local`: 以下のキーを設定
  - `GOOGLE_GEMINI_API_KEY`: Gemini API（LLM用）
  - `GOOGLE_CUSTOM_SEARCH_API_KEY`: Custom Search API（ウェブ検索用）
  - `GOOGLE_VISION_API_KEY`: Vision API（PDF OCR用）

- `lib/llm/gemini.ts`: 環境変数名を`GOOGLE_GEMINI_API_KEY`に変更

### LLM情報取得フロー（PDF対応）

```
1. 自治体の情報を取得するためにWeb検索を実行
2. 検索結果のURLを取得
3. ページを取得（page-fetcher.ts）
   - HTMLページ → テキスト抽出
   - PDF/画像URL → キャッシュ確認
     - キャッシュあり → キャッシュからテキスト取得
     - キャッシュなし → Vision APIでOCR実行、キャッシュ保存
4. 取得したテキストからLLMが情報を抽出
5. 下書きとして保存
```

### ドキュメント更新

- `docs/PROJECT.md`:
  - 技術スタックにGoogle Vision APIを追加
  - 実装済み機能にLLM情報取得時のPDF OCRを追加
  - 環境変数を整理
  - 主要ファイルにPDF OCR関連を追加

---

## ドキュメント更新: UI・CSS仕様書統合

- `docs/UI_SPEC.md`: UI仕様書とCSS仕様書を統合
  - タイトルを「UI・CSS仕様書」に変更
  - 技術スタック（Tailwind CSS, DADS design tokens, DADS tailwind plugin）を追加
  - ファイル構成と globals.css の構成を追加
  - ベーススタイル（HTML/Body、フォーカス状態、モバイルタップターゲット）を追加
  - カラーパレット（ソリッドグレー、セマンティックカラー）を追加
  - コンポーネントクラス（ページレイアウト、テキスト、リスト、連絡先、ボタン、コールアウト等）を追加
  - ユーティリティクラスを追加
  - アニメーション（シマーローディング）を追加
  - 印刷スタイルを追加
  - BEM風命名規則を追加
  - ベストプラクティスを追加
- `docs/CSS_SPEC.md`: 削除（UI_SPEC.mdに統合）

---

## コンポーネント更新: NotificationBannerのDADS仕様準拠

NotificationBannerコンポーネントをデジタル庁デザインシステム（DADS）の公式仕様に完全準拠させるよう更新。

### 必須要素・任意要素・オプション要素の明確化

**必須要素:**
- バナーアイコン: typeプロパティに基づいて自動表示
- バナータイトル: titleプロパティで指定

**任意要素:**
- バナーデスクリプション: NotificationBannerBody内のchildren

**オプション要素:**
- 年月日: NotificationBannerDate（掲載日時、掲載期間等）
- 閉じるボタン: NotificationBannerClose / NotificationBannerMobileClose
- アクションボタン: NotificationBannerActions

**共存制約:**
- リンクのみのバナー + 閉じるボタン: 不可
- アクションボタンで「閉じる」機能を実装しない（専用の閉じるボタンを使用）

### 追加コンポーネント

- `components/dads/NotificationBanner/parts/Date.tsx`: 年月日表示コンポーネント
  - ISO 8601形式（YYYY-MM-DD or YYYY-MM）の`dateTime`プロパティ
  - 表示用テキスト（"2024年7月1日", "7月1日", "2024年7月"等）
  - 月日のみ、年月のみなど柔軟に対応

- `components/dads/NotificationBanner/parts/Actions.tsx`: アクションボタンコンテナ
  - グリッドレイアウト（デスクトップは水平、モバイルは2列配置）
  - 複数ボタン対応（画角の狭いデバイスも考慮）

### 型定義・ドキュメントの追加

- `components/dads/NotificationBanner/types.ts`: 構成要素と共存制約をコメントで明記
- `components/dads/NotificationBanner/NotificationBanner.tsx`: JSDocコメントで使用例を追加
- `components/dads/NotificationBanner/index.ts`: 新しいコンポーネントをエクスポート
- `components/dads/index.ts`: 新しいコンポーネントをエクスポート

### データスキーマの拡張

- `lib/artifact/innoma-artifact-schema.v2.ts`: NotificationBannerBlockを拡張
  - `title`: 必須プロパティに変更（バナータイトルは必須要素）
  - `content`: 任意プロパティに変更（バナーデスクリプションは任意要素）
  - `date`: オプション要素（dateTime, display）
  - `showCloseButton`: オプション要素（boolean）
  - `actions`: オプション要素（label, href, variant）

### BlockRenderer実装の更新

- `components/blocks/components/NotificationBlocks.tsx`: 新しいスキーマに対応
  - NotificationBannerDate の条件付き表示
  - NotificationBannerClose の条件付き表示
  - NotificationBannerBody の条件付き表示（content が存在する場合のみ）
  - NotificationBannerActions の条件付き表示（アクションボタンのリスト）
  - Button コンポーネントとの統合（asChild で NextLink を使用）

### 確認済み
- Lint 通過（既存の img 警告のみ）
- ビルド成功

---

## 新機能: パイプライン無料枠モード

### 概要

パイプライン実行時にAPI使用量を無料枠内に制限するモードを追加。
Google Search API、Gemini API、Vision APIの無料枠を超えないように自動的に制限。

### 型定義追加 (lib/pipeline/types.ts)

- `FreeTierLimits`: API無料枠の制限設定インターフェース
  - `googleSearchQueries`: Google Search API（デフォルト: 100/日）
  - `geminiRequestsPerMinute`: Gemini API分間制限（デフォルト: 15/分）
  - `geminiRequestsPerDay`: Gemini API日間制限（デフォルト: 1500/日）
  - `visionRequestsPerMonth`: Vision API月間制限（デフォルト: 1000/月）
  - `maxPagesPerService`: サービスあたりページ取得数（デフォルト: 2）

- `DEFAULT_FREE_TIER_LIMITS`: デフォルトの無料枠制限
- `CONSERVATIVE_FREE_TIER_LIMITS`: 保守的な制限（安全マージン付き）
  - 検索10回/日、Gemini 50回/日など

- `PipelineConfig`に追加:
  - `freeTierMode?: boolean`: 無料枠モード有効化
  - `freeTierLimits?: Partial<FreeTierLimits>`: カスタム制限設定

### Pipeline クラス更新 (lib/pipeline/pipeline.ts)

- `ApiUsageTracker`: API使用量トラッカーインターフェース
- `isFreeTierLimitReached()`: API制限に達したかチェック
- `recordApiUsage()`: API使用量を記録
- `getMaxServicesForFreeTier()`: 無料枠モードでのサービス数制限
- `getMaxPagesPerService()`: 無料枠モードでのページ取得数制限
- `getApiUsageSummary()`: API使用量サマリー取得

- `stepFetch()` メソッド更新:
  - 無料枠モード時にサービス数を制限
  - API制限に達した場合は残りのサービスをスキップ
  - 完了時にAPI使用状況を表示

### CLI更新 (scripts/pipeline.ts)

- `--free-tier`: 無料枠モードを有効化
- `--search-limit <n>`: 検索API制限（デフォルト: 10）
- `--gemini-limit <n>`: Gemini API制限（デフォルト: 50）

**使用例:**
```bash
# 無料枠モードで実行
npx tsx scripts/pipeline.ts run --id takaoka --name 高岡市 --prefecture 富山県 --free-tier

# カスタム制限で実行
npx tsx scripts/pipeline.ts run --id takaoka --name 高岡市 --prefecture 富山県 --free-tier --search-limit 5 --gemini-limit 20
```

### 確認済み
- ビルド成功
- 型エラーなし

---

## 高岡市 情報構成の追加

### 変数ストアの更新 (takaoka/variables.json)

高岡市の変数ストアに以下の情報を追加（4→14変数）:

**市役所基本情報:**
- `city_hall_address`: 〒933-0057 富山県高岡市広小路7-50
- `city_hall_phone`: 0766-20-1111
- `city_hall_hours`: 平日8:30-17:15
- `city_hall_department`: 総務課

**市民課情報:**
- `shimin_department`: 市民課
- `shimin_phone`: 0766-20-1337

**手数料情報:**
- `juminhyo_fee`: 300円
- `koseki_fee`: 450円
- `inkan_shomei_fee`: 300円

**国民健康保険:**
- `kokuho_department`: 福祉保健部 保険年金課
- `kokuho_phone`: 0766-20-1357

### 情報源
- 高岡市公式ホームページ: https://www.city.takaoka.toyama.jp/
- 市民課窓口案内ページ: https://www.city.takaoka.toyama.jp/soshiki/shiminka/2/4/6/2403.html
- Yahoo!くらし: https://kurashi.yahoo.co.jp/facility/a162020001

### 確認済み
- Lint 通過（警告のみ）
- テスト通過（4/4）
- ビルド成功
