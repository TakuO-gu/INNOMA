# 2026-01-20 更新履歴

## ドキュメント整備

- `CLAUDE.md` をルートに配置（Claude Code設定専用）
- `docs/PROJECT.md` を作成（プロジェクト概要を分離）
- `docs/updates/` ディレクトリを作成（更新履歴用）

## アーカイブ（ドキュメント）

以下を `archive/docs/` に移動:
- `/README.md` → `archive/docs/ROOT_README.md`
- `/apps/web/README.md` → `archive/docs/apps_web_README.md`
- `/packages/schema/README.md` → `archive/docs/packages_schema_README.md`
- `/.claude/CLAUDE_*.md` → `archive/docs/`（セッションログ4件）

## アーカイブ（不要データ・ファイル）

以下を `archive/` に移動:
- `/data/` → `archive/data_root/`（クローラー出力、パイプライン用データ）
- `/.venv/` → `archive/.venv/`（Python仮想環境）
- `/CNAME` → `archive/CNAME`（GitHub Pages用）

以下を `archive/data/web_artifacts/` に移動:
- `apps/web/data/artifacts/aogashima*`（テスト用）
- `apps/web/data/artifacts/mikasa`（テスト用）
- `apps/web/data/artifacts/takaoka`（テスト用）
- `apps/web/data/artifacts/test-city`（テスト用）
- `apps/web/data/artifacts/utashinai`（テスト用）
- `apps/web/data/artifacts/sample-*`（テスト用）

## ディレクトリ構成変更

- `apps/web/data/artifacts/_base` → `_templates` にリネーム
- `apps/web/data/artifacts/_drafts` を新規作成
- `.gitignore` に `archive/` を追加（Gitで追跡しない）

## 現在のartifacts構成

```
apps/web/data/artifacts/
├── _templates/   # ベーステンプレート
├── _drafts/      # 下書き保存（新規作成）
└── sample/       # サンプル自治体
```

---

## 新機能追加（Phase 1実装）

### テンプレートシステム (lib/template/)

- `types.ts`: テンプレートシステムの型定義を追加
  - `VariableStore`: 変数ストアの構造
  - `MunicipalityMeta`: 自治体メタデータ
  - `MunicipalitySummary`: 自治体一覧表示用データ
  - `CreateMunicipalityInput`: 自治体追加入力
  - `PREFECTURES`: 都道府県リスト

- `clone.ts`: テンプレート複製機能を実装
  - `cloneTemplate()`: sampleテンプレートを複製して新自治体を作成
  - `extractTemplateVariables()`: テンプレート内の変数を抽出
  - `getMunicipalityPageCount()`: ページ数取得
  - `deleteMunicipality()`: 自治体削除

- `replace.ts`: 変数置換機能を実装
  - `replaceVariables()`: `{{variable_name}}`形式の変数を置換
  - `extractVariables()`: コンテンツから変数を抽出
  - `validators`: 電話番号、メール、URL、金額等の検証関数

- `storage.ts`: 自治体データ操作を実装
  - `getMunicipalities()`: 自治体一覧取得
  - `getMunicipality()`: 自治体詳細取得
  - `getMunicipalityMeta()`: メタデータ取得
  - `getVariableStore()`: 変数ストア取得
  - `updateVariableStore()`: 変数ストア更新

### 管理画面 (app/admin/)

- `layout.tsx`: 管理画面レイアウトを更新
  - ナビゲーション追加（ダッシュボード、自治体一覧、新規追加、下書き）
  - サイトプレビューリンク追加

- `page.tsx`: ダッシュボードを刷新
  - 統計表示（自治体数、ページ数、下書き数）
  - 自治体一覧（最新10件）
  - ステータスバッジ表示

- `municipalities/page.tsx`: 自治体一覧ページ
  - テーブル形式で自治体を表示
  - ステータス、ページ数、変数設定率を表示
  - プログレスバー付き

- `municipalities/new/page.tsx`: 新規自治体追加フォーム
  - 自治体ID、名前、都道府県の入力
  - 公式サイトURL入力
  - LLM情報取得オプション

- `municipalities/[id]/page.tsx`: 自治体詳細ページ
  - 基本情報と統計表示
  - 変数一覧テーブル
  - 削除機能

- `drafts/page.tsx`: 下書き一覧ページ（プレースホルダー）

### API (app/api/admin/)

- `municipalities/route.ts`: 自治体一覧・追加API
  - GET: 自治体一覧取得
  - POST: 新規自治体追加（テンプレート複製）

- `municipalities/[id]/route.ts`: 自治体詳細・更新・削除API
  - GET: 自治体詳細取得
  - PUT: 自治体更新
  - DELETE: 自治体削除

## バグ修正

- 古い静的サンプルページ (`app/municipalities/sample/`) を削除
  - 動的ルート (`[municipality]/[[...path]]/page.tsx`) で代替済み

## 設定変更

- `eslint.config.mjs`: ESLint設定を追加
  - Next.js推奨設定を適用
  - `react/display-name`をoff（既存コード対応）
  - 未使用変数の `_` プレフィックス許可

## リファクタリング

- 既存コードのLintエラー修正
  - `lib/storage/s3-adapter.ts`: 未使用引数に `_` プレフィックス
  - `components/blocks/BlockRenderer.tsx`: 未使用interfaceに `_` プレフィックス
  - `app/dev/dads/BuildingBlocksMainArea.tsx`: 未使用変数に `_` プレフィックス

---

## Phase 2 実装: LLM情報取得システム

### LLM Fetcher基盤 (lib/llm/)

- `types.ts`: LLM Fetcherシステムの型定義
  - `LLMFetchConfig`: 取得設定
  - `SearchResult`: 検索結果
  - `ExtractedVariable`: 抽出された変数
  - `FetchJob`: 取得ジョブ状態
  - `Draft`: 下書きデータ

- `google-search.ts`: Google Custom Search APIクライアント
  - `googleSearch()`: 検索実行
  - `searchMunicipalitySite()`: 自治体公式サイト内検索
  - `isOfficialDomain()`: 公式ドメイン判定
  - `calculateUrlCredibility()`: URL信頼度スコア計算

- `gemini.ts`: Google Gemini APIクライアント
  - `generateContent()`: コンテンツ生成
  - `generateJSON()`: JSON形式での構造化出力

- `prompts/query-generator.ts`: 検索クエリ生成
  - `generateSearchQuery()`: 最適な検索クエリを生成
  - `generateServiceSearchQueries()`: サービス別クエリ一括生成

- `prompts/extractor.ts`: 情報抽出
  - `extractVariables()`: ページコンテンツから変数抽出
  - `extractFromSnippets()`: 検索スニペットから抽出
  - `extractContactInfo()`: 連絡先情報特化抽出
  - `extractFeeInfo()`: 料金情報特化抽出

- `validators.ts`: 値検証
  - `validatePhone()`: 電話番号検証
  - `validateEmail()`: メールアドレス検証
  - `validateUrl()`: URL検証
  - `validateFee()`: 金額検証
  - `validateDate()`: 日付検証
  - その他各種バリデーター

- `page-fetcher.ts`: ページ取得
  - `fetchPage()`: ページ取得とテキスト抽出
  - `fetchPages()`: 複数ページ取得（レート制限対応）

- `variable-priority.ts`: 変数優先度定義
  - `highPriorityVariables`: 高優先度変数リスト
  - `serviceDefinitions`: サービス別変数グルーピング

- `fetcher.ts`: メイン取得ロジック
  - `fetchServiceVariables()`: サービス別変数取得
  - `fetchAllVariables()`: 全変数取得
  - `fetchSpecificVariables()`: 指定変数取得

### 下書きシステム (lib/drafts/)

- `types.ts`: 下書きシステムの型定義
  - `Draft`: 下書きデータ構造
  - `DraftSummary`: 一覧表示用
  - `DraftComparison`: 差分比較結果

- `storage.ts`: 下書き保存・読み込み
  - `getAllDrafts()`: 下書き一覧取得
  - `getDraft()`: 下書き詳細取得
  - `createDraft()`: 下書き作成
  - `updateDraftStatus()`: ステータス更新
  - `deleteDraft()`: 下書き削除

- `diff.ts`: 差分検出
  - `compareDraftWithStore()`: 下書きと既存変数の比較
  - `applyDraftToStore()`: 下書きを変数ストアに反映

### 管理画面 - 下書き関連

- `app/admin/drafts/page.tsx`: 下書き一覧ページ（実装完了）
  - 統計表示（総数、レビュー待ち、承認済み等）
  - 下書きテーブル（ステータス、取得状況、更新日時）

- `app/admin/drafts/[municipalityId]/[service]/page.tsx`: 下書き詳細ページ
  - 取得済み変数一覧（信頼度、ソースURL表示）
  - 未取得変数リスト
  - エラー表示

- `app/admin/drafts/[municipalityId]/[service]/DraftActions.tsx`: アクションボタン
  - 承認して反映
  - 却下
  - 削除

- `app/admin/municipalities/[id]/FetchButton.tsx`: 情報取得ボタン
  - 自治体詳細ページから直接LLM取得を実行

### API - 下書き関連

- `api/admin/drafts/route.ts`: 下書き一覧API
  - GET: 下書き一覧と統計取得

- `api/admin/drafts/[municipalityId]/[service]/route.ts`: 下書き詳細API
  - GET: 下書き詳細取得
  - PUT: 承認/却下
  - DELETE: 削除

- `api/admin/municipalities/[id]/fetch/route.ts`: LLM取得API
  - POST: 指定自治体の情報をLLMで取得

---

## Phase 3 実装: 運用機能

### 手動変数編集 (Phase 3.2)

- `app/admin/municipalities/[id]/VariableTable.tsx`: インライン編集機能を追加
  - 編集ボタンをクリックで入力フィールドに切り替え
  - 保存・キャンセル操作
  - API経由で変数を更新
  - 更新後に画面をリフレッシュ

- `api/admin/municipalities/[id]/variables/route.ts`: 変数更新API（新規作成）
  - PUT: 変数値を更新
  - 形式検証（電話番号、メール、URL等）
  - ISR再検証トリガー
  - エラーハンドリング

### ISR再検証トリガー (Phase 3.1)

- `api/admin/drafts/[municipalityId]/[service]/route.ts`: 承認時のISR再検証を追加
  - `revalidatePath()` で関連ページのキャッシュを無効化
  - 自治体ページ（`/[municipalityId]`）
  - サブページ（`/[municipalityId]/[...path]`）
  - 管理画面（`/admin/municipalities/[id]`）

### 定期更新 (Phase 3.3)

- `api/cron/update-municipalities/route.ts`: Vercel Cron Job（新規作成）
  - 毎週月曜 3:00 AM に実行
  - 更新閾値（7日以上未取得）の自治体を対象
  - 1回あたり最大5自治体を処理
  - サービス間のレート制限（2秒）
  - CRON_SECRET による認証
  - 既存の下書きがある場合はスキップ

- `vercel.json`: Cron設定を追加
  - スケジュール: `0 3 * * 1`（毎週月曜 3:00 AM UTC）

### IMPLEMENTATION_PLAN.md 更新

- Phase 3.1（承認ワークフロー）: 完了
  - [x] 承認/却下API
  - [x] 承認時のArtifact更新
  - [x] ISR再検証トリガー

- Phase 3.2（手動編集）: 完了
  - [x] 変数値の直接編集UI
  - [x] 編集履歴の記録

- Phase 3.3（定期更新）: 完了
  - [x] Vercel Cron設定
  - [x] 更新対象の自動判定
  - [x] 差分通知

---

## Phase 3 追加実装: 編集履歴・通知システム

### 編集履歴システム (lib/history/)

- `types.ts`: 編集履歴の型定義
  - `HistoryEntry`: 履歴エントリ（変更タイプ、ソース、変更内容等）
  - `VariableChange`: 変数変更の詳細
  - `HistorySummary`: 一覧表示用

- `storage.ts`: 履歴ストレージ操作
  - `addHistoryEntry()`: 履歴追加
  - `recordVariableUpdate()`: 変数更新履歴
  - `recordBulkVariableUpdate()`: 一括更新履歴
  - `recordDraftApproval()`: 下書き承認履歴
  - `recordDraftRejection()`: 下書き却下履歴
  - `getHistoryList()`: 履歴一覧取得
  - `getHistoryStats()`: 履歴統計

### 通知システム (lib/notification/)

- `types.ts`: 通知の型定義
  - `Notification`: 通知エントリ
  - `NotificationType`: 通知種類（下書き作成、承認、却下、更新等）
  - `NotificationSeverity`: 重要度（info, success, warning, error）

- `storage.ts`: 通知ストレージ操作
  - `addNotification()`: 通知追加
  - `notifyDraftCreated()`: 下書き作成通知
  - `notifyDraftApproved()`: 下書き承認通知
  - `notifyDraftRejected()`: 下書き却下通知
  - `notifyVariableUpdated()`: 変数更新通知
  - `notifyCronCompleted()`: 定期更新完了通知
  - `notifyCronFailed()`: 定期更新失敗通知
  - `getNotifications()`: 通知一覧取得
  - `markAsRead()`: 既読にする
  - `markAllAsRead()`: すべて既読にする

### API

- `api/admin/municipalities/[id]/history/route.ts`: 履歴API
  - GET: 履歴一覧・詳細・統計取得

- `api/admin/notifications/route.ts`: 通知API
  - GET: 通知一覧・詳細・統計取得
  - PUT: 既読にする
  - DELETE: 通知削除

### 管理画面UI

- `app/admin/municipalities/[id]/HistoryTable.tsx`: 履歴テーブル
  - 変更履歴の一覧表示
  - 変更種類、ソース、変更数、実行者、日時

- `app/admin/components/NotificationBell.tsx`: 通知ベル
  - ヘッダーに通知アイコン表示
  - 未読バッジ表示
  - ドロップダウンで最新通知表示

- `app/admin/notifications/page.tsx`: 通知一覧ページ
  - 全通知の一覧表示
  - フィルター（すべて/未読のみ）
  - 既読/削除操作

### 既存APIの更新

- `api/admin/municipalities/[id]/variables/route.ts`: 履歴記録追加
- `api/admin/drafts/[municipalityId]/[service]/route.ts`: 履歴・通知追加
- `api/cron/update-municipalities/route.ts`: 通知追加
