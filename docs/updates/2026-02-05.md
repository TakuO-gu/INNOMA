# 2026-02-05 更新履歴

## 出典自動表示機能（Wikipedia風参照番号）

### 概要
変数の出典をWikipedia風の脚注形式で自動表示する機能を実装。
変数が置換されると、その値の右上に`[1]`のような参照番号が自動付与され、
ページ下部に出典一覧が表示される。

### 変更内容

#### 1. 変数置換システムの拡張（lib/template/replace.ts）
- `replaceVariablesWithSourceRefs()` 関数を追加
  - 変数置換時に参照番号マーカー `⟦N⟧` を自動付与
  - 同一URLの変数は同じ参照番号にグループ化
- `ReplaceResultWithSourcesAndRefs` 型を追加（sourceRefMapを含む）

#### 2. RichTextRenderer の拡張（components/blocks/RichTextRenderer.tsx）
- `renderTextWithSourceRefs()` 関数を追加・エクスポート
  - テキスト内の `⟦N⟧` マーカーを検出
  - 上付き参照リンク `[N]` に変換
  - ページ下部の `#source-N` にジャンプ可能
- heading, paragraph の両方で参照番号マーカーを処理

#### 3. 他コンポーネントへの対応
- **ContentBlocks.tsx**
  - `TableBlock`: label と value の両方で参照番号対応
  - `DescriptionListBlock`: term と description で参照番号対応
- **InteractiveBlocks.tsx**
  - `ContactBlock`: 電話番号、FAX、メール、受付時間、住所で参照番号対応
  - `stripSourceRefs()` でリンクURL用にマーカーを除去

#### 4. SourcesBlock の自動追加（components/blocks/BlockRenderer.tsx）
- `sources` がありSourcesBlockがblocks内にない場合、自動的に追加
- 全ページで出典があれば自動的に表示される

#### 5. loader.ts の更新（lib/artifact/loader.ts）
- `replaceVariablesWithSourceRefs()` を使用して参照番号付きで変数置換

### 動作フロー
```
1. {{phone}} → 04996-9-0111⟦1⟧ （loader.ts で置換）
2. ⟦1⟧ → <sup>[1]</sup> （RichTextRenderer でレンダリング）
3. ページ下部に出典一覧を自動追加 （BlockRenderer）
4. [1] をクリック → #source-1 にスクロール
```

### 表示例
```
電話番号: 04996-9-0111[1]
受付時間: 平日8:30〜17:15[1]

---
出典
[1] www.vill.aogashima.tokyo.jp/contact/
   （2026年2月5日 参照）
```

---

## アクセシビリティ改善（JIS X 8341-3:2016 A/AA対応）

### ブロックスキップ（2.4.1対応）
- スキップリンク「本文へ移動」を追加（`app/layout.tsx`）
- 全ページの`<main>`要素に`id="main"`を追加
  - `app/[municipality]/[[...path]]/page.tsx`
  - `app/[municipality]/search/page.tsx`
  - `app/[municipality]/emergency/page.tsx`
  - `app/not-found.tsx`
  - `app/search/page.tsx`
  - `app/municipalities/page.tsx`
  - `app/municipalities/loading.tsx`

### 見出し構造の正規化（1.3.1 / 2.4.6対応）
- フッターの見出し（h3/h4）を段落（p）に変更（`components/layout/Footer.tsx`）
  - フッターは補足情報のため、見出し要素ではなく太字スタイルで表現
- `municipalities/page.tsx`の`h3`を`h2`に変更（h2スキップ問題の修正）

### 確認済み項目
- `html lang="ja"` - 既に設定済み（app/layout.tsx:15）
- HTMLバリデーション - 入れ子崩れ、id重複なし
- CSS無効時の読み順 - ヘッダー→メイン→フッターの論理順を維持

---

## テキスト文字数ルールのリファクタリング（40文字→60文字）

### 概要
コンポーネント内テキストの最大文字数閾値を40文字から60文字に変更し、
文字数判定ロジックを設定ファイルとして切り出した。

### 変更内容

#### 1. 新規設定ファイル（lib/llm/text-length-rules.ts）
- `TEXT_LENGTH_THRESHOLD = 60` - テキスト要素の最大文字数閾値
- `NOTIFICATION_BANNER_MIN_LENGTH = 50` - NotificationBanner使用の最小文字数
- `SUMMARY_LENGTH` - Summary文字数範囲（Service: 50-70字、Guide: 60-100字）
- `SECTION_DESCRIPTION_MAX_LENGTH = 60` - セクション説明文の推奨最大文字数
- `LIST_ITEM_MAX_LENGTH = 30` - 箇条書き1項目の推奨最大文字数
- ヘルパー関数: `isTextTooLong()`, `filterLongTexts()`, `getMaxTextLength()`, `hasLongItems()`

#### 2. content-structurer.ts の更新
- 40文字ハードコードをすべて`TEXT_LENGTH_THRESHOLD`定数参照に変更
- インターフェース名変更: `Validate40CharResult` → `ValidateTextLengthResult`
- 関数名変更: `validate40CharRule()` → `validateTextLengthRule()`
- LLMプロンプト内の文字数表示を動的に変更
- SERVICE_PAGE_RULESのSummary文字数を50-70字に更新

#### 3. /dev/structure ページの更新（app/dev/structure/page.tsx）
- 「40文字超えテキスト」の表示を`TEXT_LENGTH_THRESHOLD`参照に変更
- 設定ファイルからimport追加

#### 4. ドキュメント更新（docs/guides/CONTENT_ITEM_CREATION.md）
- Service Page要約: 40-60字 → 50-70字
- 説明文: 40字以内 → 60字以内

### 設計意図
- 文字数閾値を一元管理し、変更時の影響範囲を明確化
- 60文字は日本語で2〜3文程度、モバイル表示でも1〜2行に収まる目安
- 閾値変更が必要な場合、`text-length-rules.ts`の1箇所を変更するだけで対応可能

---

## Content-Item 公開スコープ管理機能

### 概要
全自治体横断で、content-item単位の公開/非公開を一括操作する機能を実装。
特定のサービスページ（例: yobosesshu）を全自治体で非公開にするなど、
グローバルな公開制御が可能になった。

### 新規ファイル

#### 1. 公開設定モジュール
- `lib/visibility/types.ts` - 型定義（VisibilityConfig, PageInfo等）
- `lib/visibility/storage.ts` - 設定読み書き、カテゴリ一括更新
- `lib/visibility/index.ts` - エクスポート

#### 2. 設定ファイル
- `data/artifacts/_config/visibility.json` - グローバル公開設定

#### 3. API
- `app/api/admin/visibility/route.ts` - GET: 設定取得 / PUT: 個別更新
- `app/api/admin/visibility/category/route.ts` - PUT: カテゴリ一括更新

#### 4. 管理画面
- `app/admin/visibility/page.tsx` - 公開設定管理UI

### 変更ファイル

#### lib/artifact/loader.ts
- `ArtifactLoadResult` に `page_not_visible` エラータイプを追加
- `getSlugFromArtifactKey()` 関数を追加（キーからスラッグ抽出）
- `loadArtifactInternal()` 内で公開設定チェックを追加

#### app/[municipality]/[[...path]]/page.tsx
- `page_not_visible` エラー時に `notFound()` を返すよう修正

#### app/admin/layout.tsx
- ナビゲーションに「公開設定」リンクを追加

### データ構造

```json
// data/artifacts/_config/visibility.json
{
  "updatedAt": "2026-02-05T00:00:00.000Z",
  "pages": {
    "yobosesshu": { "visible": false }
  },
  "defaultVisibility": true
}
```

### 機能

1. **統計表示**: 総数、公開数、非公開数
2. **カテゴリ別クイック操作**: カテゴリ単位で全公開/全非公開
3. **フィルター**: カテゴリ、状態、検索クエリ
4. **チェックボックス選択**: 複数ページを選択して一括操作
5. **個別操作**: 各ページの公開/非公開を切り替え
