# 2026-01-27 更新履歴

## リファクタリング

### 型定義の重複解消

- `lib/llm/types.ts` と `lib/drafts/types.ts` で重複していた `Draft`、`DraftVariable`、`SearchAttempt` 型を統一
- `lib/drafts/types.ts` を正とし、`lib/llm/types.ts` からは re-export する形式に変更
- 後方互換性を維持（`DraftVariable`、`SearchAttemptRecord` エイリアスを提供）

### バリデーションシステムの改善

- `VariableValidationType` 型を追加（明示的なバリデーションタイプ指定を可能に）
  - 対応タイプ: `phone`, `email`, `url`, `fee`, `percent`, `date`, `time`, `postal`, `text`
- `VariableDefinition` に `validationType` フィールドを追加
- `getValidator()` 関数を拡張し、明示的なバリデーションタイプを優先的に使用
- 変数名のパターンマッチングによる推測は後方互換性のため維持（非推奨化）

## バグ修正

- `lib/pdf/pdf-to-images.ts` の型エラーを修正（canvas.toDataURL の型推論問題）

## 新機能追加

### 地区依存変数システムの実装

同じ市区町村内でも地区（町丁目）によって値が異なる変数に対応するシステムを実装しました。

#### 対象変数

以下の変数は地区によって値が異なるため、ユーザーが地区を選択して正しい値を表示する仕組みを導入：

- **環境・ごみ**: `moeru_gomi_shushuhi`, `moenai_gomi_shushuhi`, `shigen_gomi_shushuhi`, `gomi_shushu_area`
- **防災**: `hinanjo_nearest`, `hinanjo_area`, `kinkyu_hinanbasho_nearest`
- **選挙**: `toubyousho`, `toubyoku`
- **教育**: `shogakko_gakku`, `chugakko_gakku`, `tsuugaku_shogakko`, `tsuugaku_chugakko`
- **福祉**: `houkatsu_tantou`, `minsei_iin`
- **水道**: `suidou_kyuusuiku`, `gesuidou_shori_kuiki`, `suidou_office`
- **自治会**: `jichikai`, `kouminkan`

#### 実装内容

1. **ドキュメント作成**: `docs/DISTRICT_DEPENDENT_VARIABLES.md`
2. **型定義追加**: `apps/web/lib/llm/types.ts` に `District`, `DistrictDependentVariable`, `MunicipalityDistrictData` を追加
3. **変数定義更新**: `apps/web/lib/llm/variable-priority.ts` に `districtDependentVariables` リストと `isDistrictDependentVariable()` 関数を追加
4. **処理ライブラリ作成**: `apps/web/lib/template/district-variables.ts`
5. **UIコンポーネント作成**: `apps/web/components/blocks/components/DistrictSelectorBlock.tsx`
6. **API作成**: `apps/web/app/api/districts/[municipalityId]/[variableName]/route.ts`
7. **サンプルデータ作成**: `apps/web/data/artifacts/takaoka/districts.json`
8. **テンプレート更新**: `apps/web/data/artifacts/_templates/services/environment/gomi.json` に `DistrictSelector` ブロックを追加

### TaskButtonブロックの実装

タスクボタン（カレンダー閲覧、申込ページへのリンクなど）を表示するブロックを追加。

- **コンポーネント**: `apps/web/components/blocks/components/InteractiveBlocks.tsx` に `TaskButtonBlock` を追加
- **対応プロパティ**:
  - `label`: ボタンのラベルテキスト
  - `href`: リンク先URL（内部リンク・外部リンク両対応）
  - `isTopTask`: true の場合は目立つスタイル（青背景）、false の場合は控えめなスタイル

### DistrictSelectorの機能強化

地区セレクターを大幅に強化し、検索機能と収集日情報の動的表示を実装。

#### 新機能

1. **地区名検索機能**
   - テキスト入力で町名を検索可能
   - 部分一致で候補を表示
   - 検索結果から直接地区を選択可能

2. **収集日情報の動的表示**
   - 地区を選択すると、その地区のごみ収集日を一覧表示
   - 燃やせるごみ、燃やせないごみ、資源ごみの各収集日を視覚的に表示
   - アイコンと色分けで分かりやすく

3. **API拡張**
   - `?includeAll=true` パラメータで関連する全変数データを取得可能
   - 1回のAPI呼び出しで複数の収集日情報を取得

#### 変更ファイル

- `apps/web/components/blocks/components/DistrictSelectorBlock.tsx` - 検索機能と収集日表示を追加
- `apps/web/app/api/districts/[municipalityId]/[variableName]/route.ts` - `includeAll` パラメータ対応

## 設定変更

### vitest設定のESM対応

- `vitest.config.ts` を `vitest.config.mts` にリネームしてESMモジュールとして認識させる
- vitest v4.xとviteのESM互換性問題を解決
- テストファイルの除外パターンを明示的に追加（`**/node_modules/**`, `**/dist/**`, `**/.next/**`）
