# 2026-01-21 更新履歴

## 情報取得リカバリー機能

情報取得（LLM Fetch）が途中でエラー停止した場合に、進捗を保存し再開できる機能を追加。

### 追加ファイル

| ファイル | 説明 |
|---------|------|
| `lib/jobs/types.ts` | ジョブ状態の型定義 |
| `lib/jobs/storage.ts` | ジョブの読み書き機能 |
| `lib/jobs/index.ts` | モジュールエクスポート |
| `app/api/admin/municipalities/[id]/fetch/status/route.ts` | ジョブ状態確認API |

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/api/admin/municipalities/[id]/fetch/route.ts` | ジョブ追跡と`resume`パラメータ対応 |
| `app/admin/municipalities/[id]/FetchButton.tsx` | 中断通知と再開UIを追加 |

### 機能詳細

- 情報取得中にジョブ状態が `_jobs/{municipalityId}/latest.json` に保存される
- 中断後にページを開くと「前回の取得が中断されています」通知が表示
- 「続きから再開」で完了済みサービスをスキップして再開可能
- 「最初からやり直す」で全サービスを再取得
- エラー発生時も「再試行」ボタンで再開可能

---

## 下書きページの改善（3分割ビュー）

下書き詳細ページで、変数リスト・サンプルページ・ソースコンテンツを3分割で確認できる機能を追加。

### 追加ファイル

| ファイル | 説明 |
|---------|------|
| `app/api/admin/drafts/[municipalityId]/[service]/source/route.ts` | ソースコンテンツ取得API |
| `app/api/admin/drafts/[municipalityId]/[service]/template/route.ts` | サンプルページ取得API |
| `app/admin/drafts/[municipalityId]/[service]/SourceViewer.tsx` | ソース表示コンポーネント |
| `app/admin/drafts/[municipalityId]/[service]/TemplatePreview.tsx` | サンプルページプレビューコンポーネント |
| `app/admin/drafts/[municipalityId]/[service]/VariableContextViewer.tsx` | 3分割ビューコンポーネント |

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/admin/drafts/[municipalityId]/[service]/page.tsx` | 従来のテーブル表示を3分割ビューに置換 |

### 機能詳細

- **左パネル（25%幅）**: 取得済み変数と未取得変数をタブで切り替え
- **中央パネル（37.5%幅）**: サンプルページプレビュー（サンプル市の例）
  - サンプルページを表示し、変数がどのブロックで使用されているか示す
  - 選択した変数の使用箇所を黄色ハイライト
  - サンプル市の値が表示され、その値が黄色でハイライト
- **右パネル（37.5%幅）**: 選択した変数のソースURLの内容を表示
  - 取得した値がハイライト表示される
- 変更タイプ（新規/変更）の表示
- 信頼度のカラーコード表示（緑: ≥80%, 黄: ≥50%, 赤: <50%）
- 未取得変数を選択すると、サンプルページ上の使用箇所のみ表示

---

## 自治体詳細ページに公開ボタン追加

自治体詳細ページ（`/admin/municipalities/[id]`）に「公開」ボタンを追加。全ての変数が設定されていなくても公開できるように変更。

### 追加ファイル

| ファイル | 説明 |
|---------|------|
| `app/admin/municipalities/[id]/PublishButton.tsx` | 公開/非公開切り替えボタン |

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/api/admin/municipalities/[id]/route.ts` | ステータス更新機能を追加 |
| `lib/template/index.ts` | `updateMunicipalityStatus`をエクスポート |
| `app/admin/municipalities/[id]/page.tsx` | PublishButtonを追加 |

### 機能詳細

- ステータスが「作成中」の場合は「公開する」ボタン（緑）を表示
- ステータスが「公開中」の場合は「非公開にする」ボタン（グレー）を表示
- 変数の設定状況に関係なく公開可能
- 確認ダイアログを表示後にステータスを切り替え

---

## 公開状態による自治体表示フィルタリング

公開中（`status === "published"`）の自治体のみがトップページと自治体一覧ページに表示されるように変更。

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/page.tsx` | 公開中の自治体のみを「対応自治体」セクションに表示（最大4件） |
| `app/municipalities/page.tsx` | 公開中の自治体のみを一覧表示 |

### 機能詳細

- トップページの「対応自治体」セクション: 公開中の自治体を最大4件表示
- `/municipalities` 自治体一覧ページ: 公開中の自治体のみ表示
- 都道府県フィルタも公開中自治体の都道府県のみ選択可能
- 非公開（draft）の自治体は一般向けページには表示されない

---

## 情報取得機能の改善（サービス単位での取得）

情報取得機能を改善し、サービスごとの取得状況を確認し、未取得のサービスのみを選択して取得できるように変更。

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/admin/municipalities/[id]/FetchButton.tsx` | サービス選択UI、取得状況サマリーを追加 |
| `app/api/admin/municipalities/[id]/fetch/status/route.ts` | サービスごとの下書き状況を返すように拡張 |
| `app/api/admin/municipalities/[id]/fetch/route.ts` | `onlyMissing`と`services`パラメータに対応 |

### 機能詳細

- **取得状況サマリー表示**:
  - サービス数、未取得サービス数、取得済みサービス数、未取得変数数を表示
- **3つの取得モード**:
  1. 「未取得のみ取得」: 下書きがないサービス、または未取得変数があるサービスのみ取得
  2. 「全て再取得」: 全サービスを再取得（全ての変数が取得済みの場合に表示）
  3. 「サービスを選択して取得」: 取得したいサービスを個別に選択可能
- **サービス選択UI**:
  - 各サービスの取得状況（未取得/部分取得/全取得済み）を色分け表示
  - チェックボックスで取得したいサービスを選択
  - 全選択/全解除ボタン

---

## 変数設定率の動的計算

自治体詳細ページの「変数設定率」がテンプレートから動的に計算されるように修正。

### 問題点

- 変数の総数がハードコード（353）されていた
- 実際のテンプレート変数数（343）と異なっていた
- `serviceDefinitions`の変数数とも乖離していた

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `lib/template/clone.ts` | `getTotalVariableCount()`, `getAllTemplateVariableNames()` を追加 |
| `lib/template/storage.ts` | ハードコードの353を `getTotalVariableCount()` に置換 |
| `lib/template/index.ts` | 新関数をエクスポート |

### 機能詳細

- テンプレートファイル（`_templates/`）から `{{variable_name}}` 形式の変数を抽出
- 変数数はキャッシュされるためパフォーマンス影響なし
- 実際のテンプレート変数数: **343個**

---

## サービス定義をテンプレート構造に統一

`serviceDefinitions`（LLM取得で使用するサービス定義）をテンプレートディレクトリ（`_templates/services/`）の構造に合わせて更新。

### 問題点

- `serviceDefinitions`: 9サービス（shimin, kokuho, kouki, tax, childcare, welfare, health, environment, disaster）
- テンプレート: 15カテゴリ（registration, tax, health, childcare, welfare, environment, disaster, housing, employment, driving, business, land, nationality, civic, benefits）
- サービスIDと変数定義が大きく乖離していた

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `lib/llm/variable-priority.ts` | `serviceDefinitions`を15カテゴリに拡張、各カテゴリに正しい変数を設定 |

### 変更後のサービス一覧

| ID | 日本語名 | 変数数 |
|----|---------|--------|
| registration | 届出・申請・証明書 | 29 |
| tax | 税金 | 13 |
| health | 健康・医療 | 37 |
| childcare | 子育て・保育 | 33 |
| welfare | 福祉 | 21 |
| environment | 環境・ごみ | 18 |
| disaster | 防災 | 20 |
| housing | 住宅・建築 | 20 |
| employment | 雇用・労働 | 21 |
| driving | 運転・車 | 17 |
| business | 事業・産業 | 13 |
| land | 土地・農林水産 | 29 |
| nationality | 外国人・国籍 | 29 |
| civic | 市民参加・選挙 | 28 |
| benefits | 年金・給付 | 6 |

---

## 自治体詳細ページの変数設定率をserviceDefinitionsに統一

変数設定率の計算を`serviceDefinitions`ベースに変更し、サービス別変数設定状況を表示する機能を追加。

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `lib/template/storage.ts` | 変数カウントを`serviceDefinitions`ベースに変更 |
| `app/admin/municipalities/[id]/page.tsx` | 3カラムレイアウトに変更、ServiceVariableStatsを追加 |

### 追加ファイル

| ファイル | 説明 |
|---------|------|
| `app/admin/municipalities/[id]/ServiceVariableStats.tsx` | サービス別変数設定状況コンポーネント |

### 機能詳細

- 変数設定率は`serviceDefinitions`で定義された変数のみをカウント
- 自治体詳細ページに「サービス別変数設定状況」カードを追加
- 各サービスの設定率をプログレスバーで表示
  - 緑: 100%完了
  - 黄: 50%以上
  - オレンジ: 1%以上
  - グレー: 0%

---

## ページ表示時の変数動的置換

Artifactページを表示する際に、`variables.json`に保存された変数値をリアルタイムで置換するように変更。

### 問題点

- 変数は`variables.json`に保存されていたが、ページファイル（例: `gomi.json`）には`{{変数名}}`のままだった
- ページを表示しても変数が置換されず、`{{moeru_gomi_dashikata}}`などがそのまま表示されていた

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `lib/artifact/loader.ts` | Artifact読み込み時に`variables.json`から変数値を取得し、動的に置換するように変更 |
| `lib/template/replace.ts` | JSON用エスケープ関数 `escapeForJson()`, `variableStoreToMapForJson()` を追加 |
| `lib/template/index.ts` | 新関数をエクスポート |

### 機能詳細

- Artifact読み込み時（`loadArtifactInternal`）でmunicipalityIdを抽出
- 該当自治体の`variables.json`を読み込み
- **変数値に含まれる改行・特殊文字をJSONエスケープ**（`\n` → `\\n`など）
- JSONパース前にテキストレベルで変数置換を実行
- 未置換の変数があればログに記録

---

## LLM情報取得用の変数説明を追加

LLMがWebページから情報を抽出する際に、変数名だけでは期待する情報を正しく取得できない問題を修正。

### 問題点

- `moeru_gomi_dashikata`（燃やせるごみの出し方）に「対象品目リスト」が取得されていた
- `moenai_gomi_shushuhi`（燃やせないごみの収集費）に「処理手数料」が取得されていた
- LLMに渡されるdescriptionが変数名そのままになっていた（説明が定義されていない変数）

### 原因

`getVariableDefinition()`関数が`highPriorityVariables`のみを参照しており、そこに定義されていない変数は説明なし（変数名がそのままdescriptionとして使用）となっていた。

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `lib/llm/variable-priority.ts` | `variableDescriptions`マップを追加（約200変数の日本語説明を定義）、`getVariableDefinition()`を拡張 |

### 追加された変数説明のカテゴリ

- 環境・ごみ系（18変数）
- 防災系（20変数）
- 住宅・建築系（20変数）
- 雇用・労働系（21変数）
- 運転・車系（17変数）
- 事業・産業系（13変数）
- 土地・農林水産系（29変数）
- 外国人・国籍系（29変数）
- 市民参加・選挙系（28変数）
- 年金・給付系（6変数）

### 機能詳細

- 各変数に日本語の`description`（説明）と必要に応じて`examples`（例）を定義
- 例: `moeru_gomi_dashikata` → `"燃やせるごみの出し方（袋の種類、縛り方など）"`、例: `["透明または半透明の袋に入れて出す"]`
- `getVariableDefinition()`は`highPriorityVariables`→`variableDescriptions`の順で検索
- LLMは具体的な説明と例を参照して、正しい情報を抽出できるようになる

### 注意

この修正は**新規取得時**にのみ効果があります。既に取得済みの不正な値を修正するには、該当サービス（環境・ごみなど）を再取得する必要があります。

---

## 情報取得の中断ボタン追加

情報取得中に「中断」ボタンを表示し、処理を途中で止められるように改善。

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/admin/municipalities/[id]/FetchButton.tsx` | AbortControllerを使用した中断機能を追加 |

### 機能詳細

- 取得中に「中断」ボタン（赤いボタン）を表示
- クリックするとSSE接続をabortし、処理を即座に停止
- 中断後はidleステータスに戻り、再度取得を開始可能
- 中断時点までに完了したサービスの下書きは保持される

---

## missingVariablesの修正

下書きに未取得変数が正しく記録されない問題を修正。

### 問題点

- LLMが取得できなかった変数が`missingVariables`に追加されなかった
- 下書きページで「未取得変数」タブが空になっていた

### 原因

`fetch/route.ts`で、LLMの結果に含まれる変数のみを処理していたため、サービス定義に存在するがLLMが返さなかった変数は記録されなかった。

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/api/admin/municipalities/[id]/fetch/route.ts` | サービス定義から全変数を取得し、取得できなかった変数を`missingVariables`に追加 |

### 機能詳細

- `service.variables`から全変数リストを取得
- 取得できた変数名をSetで追跡
- Setに含まれない変数を`missingVariables`として記録
- 下書きページで未取得変数が正しく表示されるようになる

---

## サービス取得状況の表示不整合を修正

一部のサービスで「全取得済み」と表示されるが、実際には未取得変数がある問題を修正。

### 問題点

- FetchButtonのサービス選択UIで「届出・申請・証明書」が「全て取得済み」と表示されていた
- 実際には29変数中19変数のみ取得済み（10変数が未取得）

### 原因

status API（`/api/admin/municipalities/[id]/fetch/status`）が`missingCount`をドラフトの`missingVariables`配列の長さから取得していた。しかし、今日の修正前に作成されたドラフトは`missingVariables`が空の配列のまま保存されていたため、未取得変数が0件として報告されていた。

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/api/admin/municipalities/[id]/fetch/status/route.ts` | `missingCount`をサービス定義から動的に計算するように修正 |

### 機能詳細

- `missingCount`の計算をドラフトの`missingVariables`配列に依存しないように変更
- サービス定義の全変数リストから、ドラフトに存在する変数を除外して未取得変数を計算
- 古いドラフトでも正しく未取得変数数が表示されるようになる

```typescript
// 修正前
const missingCount = draft.missingVariables.length;

// 修正後
const fetchedVariableNames = new Set(Object.keys(draft.variables));
const missingCount = serviceDef.variables.filter(
  (varName) => !fetchedVariableNames.has(varName)
).length;
```

---

## 検証済み

- Lint通過（既存のimg警告のみ）
- ビルド成功
